{% extends "base.html" %}

{% block title %}Survival Companion - Weather{% endblock %}

{% block content %}
<div class="weather-container">
    <div class="current-conditions card">
        <h2>Current Conditions</h2>
        <div class="conditions-grid">
            <div class="condition-main">
                <span class="temp-large" id="weather-temp">23.5</span>
                <span class="temp-unit">¬∞C</span>
            </div>
            <div class="condition-secondary">
                <div class="condition-row">
                    <span class="label">Humidity</span>
                    <span class="value" id="weather-humidity">65%</span>
                </div>
                <div class="condition-row">
                    <span class="label">Pressure</span>
                    <span class="value" id="weather-pressure">1013 hPa</span>
                </div>
                <div class="condition-row">
                    <span class="label">Altitude</span>
                    <span class="value" id="weather-altitude">58 m</span>
                </div>
            </div>
        </div>
    </div>

    <div class="pressure-trend card">
        <h2>Pressure Trend (3hr)</h2>
        <div class="trend-indicator" id="pressure-trend">
            <div class="trend-arrow stable">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22 12l-4-4v3H3v2h15v3z"/>
                </svg>
            </div>
            <div class="trend-text">
                <span class="trend-label">Stable</span>
                <span class="trend-change">+0.2 hPa</span>
            </div>
        </div>
        <div class="trend-graph">
            <div class="graph-bars">
                <div class="bar" style="height: 60%"></div>
                <div class="bar" style="height: 62%"></div>
                <div class="bar" style="height: 61%"></div>
                <div class="bar" style="height: 63%"></div>
                <div class="bar" style="height: 64%"></div>
                <div class="bar" style="height: 63%"></div>
                <div class="bar active" style="height: 63%"></div>
            </div>
            <div class="graph-labels">
                <span>-3h</span>
                <span>Now</span>
            </div>
        </div>
    </div>

    <div class="alerts card">
        <h2>Weather Alerts</h2>
        <div id="weather-alerts">
            <div id="no-alerts" class="alert-item success">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span>No severe weather expected</span>
            </div>
            <div id="storm-alert" class="alert-item danger hidden">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                </svg>
                <div class="storm-alert-content">
                    <span class="storm-alert-severity" id="storm-severity">SEVERE</span>
                    <span class="storm-alert-message" id="storm-message">Storm warning</span>
                    <span class="storm-alert-action" id="storm-action">Take shelter</span>
                </div>
            </div>
        </div>
    </div>

    <div class="recommendations card">
        <h2>Activity Recommendations</h2>
        <div class="recommendation-list">
            <div class="recommendation good">
                <span class="rec-icon">üëç</span>
                <span class="rec-text">Safe to travel</span>
            </div>
            <div class="recommendation info">
                <span class="rec-icon">üíß</span>
                <span class="rec-text">Stay hydrated</span>
            </div>
            <div class="recommendation info">
                <span class="rec-icon">üß•</span>
                <span class="rec-text">Light layers recommended</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .weather-container {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .current-conditions .conditions-grid {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .condition-main {
        display: flex;
        align-items: flex-start;
    }

    .temp-large {
        font-size: var(--font-size-3xl);
        font-weight: 700;
        line-height: 1;
    }

    .temp-unit {
        font-size: var(--font-size-xl);
        color: var(--text-secondary);
        margin-left: var(--spacing-xs);
    }

    .condition-secondary {
        text-align: right;
    }

    .condition-row {
        display: flex;
        justify-content: space-between;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xs);
    }

    .condition-row .label {
        color: var(--text-muted);
        font-size: var(--font-size-sm);
    }

    .condition-row .value {
        font-weight: 600;
        font-size: var(--font-size-sm);
    }

    .pressure-trend .trend-indicator {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }

    .trend-arrow {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .trend-arrow svg {
        width: 24px;
        height: 24px;
    }

    .trend-arrow.stable {
        background: rgba(34, 197, 94, 0.2);
        color: var(--accent-primary);
    }

    .trend-arrow.rising {
        background: rgba(245, 158, 11, 0.2);
        color: var(--accent-warning);
        transform: rotate(-45deg);
    }

    .trend-arrow.falling {
        background: rgba(239, 68, 68, 0.2);
        color: var(--accent-danger);
        transform: rotate(45deg);
    }

    .trend-label {
        display: block;
        font-weight: 600;
    }

    .trend-change {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
    }

    .trend-graph {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
    }

    .graph-bars {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        height: 60px;
        gap: var(--spacing-sm);
    }

    .bar {
        flex: 1;
        background: var(--text-muted);
        border-radius: var(--radius-sm);
        opacity: 0.5;
    }

    .bar.active {
        background: var(--accent-secondary);
        opacity: 1;
    }

    .graph-labels {
        display: flex;
        justify-content: space-between;
        margin-top: var(--spacing-xs);
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }

    .alerts .alert-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm);
        border-radius: var(--radius-md);
    }

    .alert-item svg {
        width: 20px;
        height: 20px;
    }

    .alert-item.success {
        background: rgba(34, 197, 94, 0.1);
        color: var(--accent-primary);
    }

    .alert-item.warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--accent-warning);
    }

    .alert-item.danger {
        background: rgba(239, 68, 68, 0.1);
        color: var(--accent-danger);
    }

    .recommendation-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }

    .recommendation {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm);
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
    }

    .rec-icon {
        font-size: 20px;
    }

    .rec-text {
        font-size: var(--font-size-sm);
    }

    .recommendation.good {
        border-left: 3px solid var(--accent-primary);
    }

    .recommendation.info {
        border-left: 3px solid var(--accent-secondary);
    }

    .recommendation.caution {
        border-left: 3px solid var(--accent-warning);
    }

    /* Storm Alert Styles */
    #storm-alert {
        flex-direction: column;
        align-items: flex-start;
        animation: storm-pulse 1s infinite;
    }

    #storm-alert.hidden {
        display: none;
    }

    #storm-alert svg {
        align-self: flex-start;
    }

    @keyframes storm-pulse {
        0%, 100% {
            background: rgba(239, 68, 68, 0.1);
        }
        50% {
            background: rgba(239, 68, 68, 0.25);
        }
    }

    .storm-alert-content {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        width: 100%;
    }

    .storm-alert-severity {
        font-weight: 700;
        font-size: var(--font-size-lg);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .storm-alert-message {
        font-size: var(--font-size-base);
    }

    .storm-alert-action {
        font-size: var(--font-size-sm);
        background: rgba(0, 0, 0, 0.3);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
        margin-top: var(--spacing-xs);
    }

    /* Severity-specific colors */
    #storm-alert.minor {
        background: rgba(245, 158, 11, 0.1);
        color: var(--accent-warning);
        animation: none;
    }

    #storm-alert.moderate {
        background: rgba(245, 158, 11, 0.2);
        color: var(--accent-warning);
    }

    #storm-alert.severe {
        background: rgba(239, 68, 68, 0.15);
        color: var(--accent-danger);
    }

    #storm-alert.extreme {
        background: rgba(239, 68, 68, 0.25);
        color: var(--accent-danger);
        animation: storm-pulse-extreme 0.5s infinite;
    }

    @keyframes storm-pulse-extreme {
        0%, 100% {
            background: rgba(239, 68, 68, 0.25);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }
        50% {
            background: rgba(239, 68, 68, 0.4);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Storm alert audio
    let stormAlertAudio = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadWeatherData();

        // Refresh every 30 seconds
        setInterval(loadWeatherData, 30000);
    });

    async function loadWeatherData() {
        try {
            // Use the new weather API instead of sensors
            const response = await fetch('/api/weather');
            const weather = await response.json();

            if (weather) {
                // Update temperature
                if (weather.temperature) {
                    document.getElementById('weather-temp').textContent = weather.temperature.value.toFixed(1);
                }

                // Update humidity
                if (weather.humidity) {
                    document.getElementById('weather-humidity').textContent = weather.humidity.value + '%';
                }

                // Update pressure
                if (weather.pressure) {
                    document.getElementById('weather-pressure').textContent = weather.pressure.value.toFixed(0) + ' hPa';

                    // Update pressure trend
                    updatePressureTrend(weather.pressure.trend, weather.pressure.trend_change);

                    // Update pressure graph
                    if (weather.pressure.history) {
                        updatePressureGraph(weather.pressure.history);
                    }
                }

                // Update altitude
                if (weather.altitude !== undefined) {
                    document.getElementById('weather-altitude').textContent = weather.altitude + ' m';
                }

                // Handle storm alerts
                handleStormAlert(weather.storm_alert);
            }
        } catch (error) {
            console.error('Failed to load weather data:', error);
            // Fallback to sensors API
            const sensors = await loadSensorData();
            if (sensors) {
                if (sensors.temperature) {
                    document.getElementById('weather-temp').textContent = sensors.temperature.value.toFixed(1);
                }
                if (sensors.humidity) {
                    document.getElementById('weather-humidity').textContent = sensors.humidity.value + '%';
                }
                if (sensors.pressure) {
                    document.getElementById('weather-pressure').textContent = sensors.pressure.value.toFixed(0) + ' hPa';
                }
                if (sensors.gps) {
                    document.getElementById('weather-altitude').textContent = sensors.gps.altitude + ' m';
                }
            }
        }
    }

    function updatePressureTrend(trend, change) {
        const trendIndicator = document.getElementById('pressure-trend');
        const trendArrow = trendIndicator.querySelector('.trend-arrow');
        const trendLabel = trendIndicator.querySelector('.trend-label');
        const trendChange = trendIndicator.querySelector('.trend-change');

        // Remove existing classes
        trendArrow.classList.remove('stable', 'rising', 'falling');

        // Set new class and label
        switch (trend) {
            case 'rising':
                trendArrow.classList.add('rising');
                trendLabel.textContent = 'Rising';
                break;
            case 'falling':
                trendArrow.classList.add('falling');
                trendLabel.textContent = 'Falling';
                break;
            default:
                trendArrow.classList.add('stable');
                trendLabel.textContent = 'Stable';
        }

        // Format change value
        const changeVal = parseFloat(change);
        const sign = changeVal >= 0 ? '+' : '';
        trendChange.textContent = `${sign}${changeVal.toFixed(1)} hPa`;
    }

    function updatePressureGraph(history) {
        const bars = document.querySelectorAll('.graph-bars .bar');
        if (history.length === 0 || bars.length === 0) return;

        // Find min/max for scaling
        const pressures = history.map(h => h.pressure);
        const min = Math.min(...pressures) - 2;
        const max = Math.max(...pressures) + 2;
        const range = max - min;

        // Update bars
        bars.forEach((bar, index) => {
            if (index < history.length) {
                const pressure = history[index].pressure;
                const height = Math.max(10, Math.min(100, ((pressure - min) / range) * 100));
                bar.style.height = `${height}%`;

                // Mark latest as active
                bar.classList.toggle('active', index === history.length - 1);
            }
        });
    }

    function handleStormAlert(alert) {
        const noAlertsEl = document.getElementById('no-alerts');
        const stormAlertEl = document.getElementById('storm-alert');
        const severityEl = document.getElementById('storm-severity');
        const messageEl = document.getElementById('storm-message');
        const actionEl = document.getElementById('storm-action');

        if (alert) {
            // Show storm alert
            noAlertsEl.classList.add('hidden');
            stormAlertEl.classList.remove('hidden');

            // Update severity class
            stormAlertEl.className = 'alert-item danger ' + alert.severity;

            // Update content
            severityEl.textContent = alert.severity.toUpperCase() + ' STORM WARNING';
            messageEl.textContent = alert.message;
            actionEl.textContent = 'Action: ' + alert.recommended_action;

            // Play audio for severe/extreme alerts
            if (alert.audio_alert) {
                playStormAlert();
            }
        } else {
            // Hide storm alert, show no alerts
            noAlertsEl.classList.remove('hidden');
            stormAlertEl.classList.add('hidden');
            stopStormAlert();
        }
    }

    function playStormAlert() {
        // Create audio context for alert sound
        if (!stormAlertAudio) {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const audioCtx = new AudioContext();

                function beep() {
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);

                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    gainNode.gain.value = 0.3;

                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.2);
                }

                // Beep 3 times
                beep();
                setTimeout(beep, 300);
                setTimeout(beep, 600);

                // Store to prevent repeated plays
                stormAlertAudio = true;
            } catch (e) {
                console.log('Audio not available');
            }
        }
    }

    function stopStormAlert() {
        stormAlertAudio = null;
    }
</script>
{% endblock %}
