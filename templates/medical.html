{% extends "base.html" %}

{% block title %}Survival Companion - Medical{% endblock %}

{% block content %}
<div class="medical-container">
    <div class="search-box">
        <input type="text" id="medical-search" placeholder="Search conditions or injuries... (e.g., bee sting)" autocomplete="off">
        <div id="search-results" class="search-results hidden"></div>
    </div>

    <div class="medical-categories">
        <button class="category-btn active" data-category="all">All</button>
        <button class="category-btn" data-category="wound">Wounds</button>
        <button class="category-btn" data-category="cardiac">Cardiac</button>
        <button class="category-btn" data-category="environmental">Environmental</button>
        <button class="category-btn" data-category="poison">Poison/Stings</button>
    </div>

    <div id="protocols-list" class="protocols-list">
        <!-- Protocols loaded dynamically from API -->
        <div class="loading-indicator" id="protocols-loading">
            <span>Loading protocols...</span>
        </div>
    </div>

    <!-- Protocol Detail Modal -->
    <div id="protocol-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal-severity" class="severity">Severity</span>
                <h2 id="modal-title">Protocol Title</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Anaphylaxis Warning (if applicable) -->
                <div class="anaphylaxis-warning hidden" id="modal-anaphylaxis">
                    <h4>‚ö†Ô∏è ANAPHYLAXIS WARNING</h4>
                    <div class="anaphylaxis-symptoms" id="anaphylaxis-symptoms"></div>
                    <div class="anaphylaxis-actions" id="anaphylaxis-actions"></div>
                </div>

                <div class="protocol-summary-box" id="modal-summary">
                    <!-- Summary displayed here -->
                </div>

                <h3>Steps</h3>
                <div class="protocol-steps" id="modal-steps">
                    <!-- Steps loaded dynamically -->
                </div>

                <div class="protocol-warnings" id="modal-warnings">
                    <!-- Warnings loaded dynamically -->
                </div>

                <div class="protocol-contraindications hidden" id="modal-contraindications">
                    <!-- Contraindications -->
                </div>

                <div class="protocol-seek-help" id="modal-seek-help">
                    <!-- When to seek help -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .medical-container {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .search-box {
        position: sticky;
        top: calc(var(--status-bar-height) + var(--spacing-md));
        z-index: 10;
    }

    .search-box input {
        width: 100%;
        padding: var(--spacing-md);
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: var(--font-size-base);
    }

    .search-box input::placeholder {
        color: var(--text-muted);
    }

    .search-box input:focus {
        outline: none;
        border-color: var(--accent-secondary);
    }

    .loading-indicator {
        text-align: center;
        padding: var(--spacing-lg);
        color: var(--text-muted);
    }

    .medical-categories {
        display: flex;
        gap: var(--spacing-xs);
        overflow-x: auto;
        padding-bottom: var(--spacing-xs);
    }

    .category-btn {
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--bg-card);
        border: none;
        border-radius: var(--radius-full);
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
        white-space: nowrap;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
    }

    .category-btn.active {
        background: var(--accent-secondary);
        color: white;
    }

    .protocols-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }

    .protocol-card {
        background: var(--bg-card);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        cursor: pointer;
        transition: background 0.2s, transform 0.1s;
    }

    .protocol-card:active {
        background: var(--bg-hover);
        transform: scale(0.99);
    }

    .protocol-card.hidden {
        display: none;
    }

    .protocol-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-xs);
    }

    .severity {
        padding: 2px 8px;
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: 600;
        text-transform: uppercase;
    }

    .severity.minor {
        background: rgba(34, 197, 94, 0.2);
        color: var(--accent-primary);
    }

    .severity.moderate {
        background: rgba(245, 158, 11, 0.2);
        color: var(--accent-warning);
    }

    .severity.critical {
        background: rgba(239, 68, 68, 0.2);
        color: var(--accent-danger);
    }

    .protocol-header h3 {
        font-size: var(--font-size-base);
        font-weight: 600;
    }

    .protocol-summary {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
    }

    /* Modal */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 2000;
        display: flex;
        align-items: flex-end;
    }

    .modal-content {
        background: var(--bg-secondary);
        width: 100%;
        max-height: 85vh;
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-wrap: wrap;
        gap: var(--spacing-sm);
    }

    .modal-header h2 {
        font-size: var(--font-size-lg);
        flex: 1;
    }

    .modal-close {
        width: 40px;
        height: 40px;
        background: none;
        border: none;
        color: var(--text-primary);
        font-size: 24px;
        cursor: pointer;
    }

    .modal-body {
        padding: var(--spacing-md);
        overflow-y: auto;
        flex: 1;
    }

    .modal-body h3 {
        margin-top: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
        font-size: var(--font-size-base);
        color: var(--text-secondary);
    }

    .protocol-summary-box {
        background: rgba(59, 130, 246, 0.1);
        padding: var(--spacing-md);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-md);
        color: var(--text-primary);
    }

    .protocol-steps ol {
        padding-left: var(--spacing-lg);
        margin: 0;
    }

    .protocol-steps li {
        margin-bottom: var(--spacing-md);
        line-height: 1.5;
    }

    .protocol-steps li strong {
        display: block;
        color: var(--accent-primary);
        margin-bottom: 4px;
    }

    .protocol-steps li .step-detail {
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
    }

    /* Anaphylaxis Warning */
    .anaphylaxis-warning {
        background: rgba(239, 68, 68, 0.2);
        border: 2px solid var(--accent-danger);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }

    .anaphylaxis-warning h4 {
        color: var(--accent-danger);
        margin-bottom: var(--spacing-sm);
        font-size: var(--font-size-base);
    }

    .anaphylaxis-symptoms h5,
    .anaphylaxis-actions h5 {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        margin-bottom: var(--spacing-xs);
    }

    .anaphylaxis-symptoms ul,
    .anaphylaxis-actions ul {
        padding-left: var(--spacing-md);
        margin: 0 0 var(--spacing-sm) 0;
    }

    .anaphylaxis-symptoms li,
    .anaphylaxis-actions li {
        font-size: var(--font-size-sm);
        line-height: 1.4;
        margin-bottom: 4px;
    }

    .anaphylaxis-actions {
        background: rgba(239, 68, 68, 0.3);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
    }

    .protocol-warnings {
        background: rgba(239, 68, 68, 0.1);
        border-left: 3px solid var(--accent-danger);
        padding: var(--spacing-md);
        margin-top: var(--spacing-md);
        border-radius: var(--radius-sm);
    }

    .protocol-warnings h4 {
        color: var(--accent-danger);
        margin-bottom: var(--spacing-sm);
        font-size: var(--font-size-sm);
    }

    .protocol-warnings ul {
        padding-left: var(--spacing-md);
        margin: 0;
    }

    .protocol-warnings li {
        font-size: var(--font-size-sm);
        margin-bottom: 4px;
        line-height: 1.4;
    }

    .protocol-contraindications {
        background: rgba(245, 158, 11, 0.1);
        border-left: 3px solid var(--accent-warning);
        padding: var(--spacing-md);
        margin-top: var(--spacing-md);
        border-radius: var(--radius-sm);
    }

    .protocol-contraindications h4 {
        color: var(--accent-warning);
        margin-bottom: var(--spacing-sm);
        font-size: var(--font-size-sm);
    }

    .protocol-seek-help {
        background: rgba(59, 130, 246, 0.1);
        border-left: 3px solid var(--accent-secondary);
        padding: var(--spacing-md);
        margin-top: var(--spacing-md);
        border-radius: var(--radius-sm);
    }

    .protocol-seek-help h4 {
        color: var(--accent-secondary);
        margin-bottom: var(--spacing-sm);
        font-size: var(--font-size-sm);
    }

    .protocol-seek-help p {
        font-size: var(--font-size-sm);
        line-height: 1.5;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let allProtocols = [];
    let currentCategory = 'all';

    document.addEventListener('DOMContentLoaded', function() {
        // Load protocols from API on page load
        loadProtocols();

        // Category filtering
        const categoryBtns = document.querySelectorAll('.category-btn');
        categoryBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                categoryBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentCategory = this.dataset.category;
                filterAndRenderProtocols();
            });
        });

        // Search filtering
        const searchInput = document.getElementById('medical-search');
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterAndRenderProtocols();
            }, 200);
        });

        // Modal close
        document.querySelector('.modal-close').addEventListener('click', closeModal);
        document.getElementById('protocol-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    });

    async function loadProtocols() {
        try {
            const response = await fetch('/api/protocols');
            const data = await response.json();
            if (data.success) {
                allProtocols = data.protocols;
                filterAndRenderProtocols();
            }
        } catch (error) {
            console.error('Failed to load protocols:', error);
            document.getElementById('protocols-loading').textContent = 'Failed to load protocols';
        }
    }

    function filterAndRenderProtocols() {
        const searchInput = document.getElementById('medical-search');
        const query = searchInput.value.toLowerCase();

        let filtered = allProtocols;

        // Filter by category
        if (currentCategory !== 'all') {
            filtered = filtered.filter(p => p.category === currentCategory);
        }

        // Filter by search query
        if (query) {
            filtered = filtered.filter(p => {
                const nameMatch = p.name.toLowerCase().includes(query);
                const summaryMatch = p.summary.toLowerCase().includes(query);
                const keywordMatch = p.keywords && p.keywords.some(k => k.toLowerCase().includes(query));
                return nameMatch || summaryMatch || keywordMatch;
            });
        }

        renderProtocols(filtered);
    }

    function renderProtocols(protocols) {
        const container = document.getElementById('protocols-list');

        if (protocols.length === 0) {
            container.innerHTML = '<div class="loading-indicator">No protocols found</div>';
            return;
        }

        container.innerHTML = protocols.map(p => `
            <div class="protocol-card" data-id="${p.id}" data-category="${p.category}">
                <div class="protocol-header">
                    <span class="severity ${p.severity}">${p.severity}</span>
                    <h3>${p.name}</h3>
                </div>
                <p class="protocol-summary">${p.summary}</p>
            </div>
        `).join('');

        // Add click handlers
        container.querySelectorAll('.protocol-card').forEach(card => {
            card.addEventListener('click', function() {
                const id = parseInt(this.dataset.id);
                showProtocolModalById(id);
            });
        });
    }

    async function showProtocolModalById(id) {
        try {
            const response = await fetch(`/api/protocols/${id}`);
            const data = await response.json();

            if (!data.success) {
                alert('Protocol not found');
                return;
            }

            showProtocolModal(data.protocol);
        } catch (error) {
            console.error('Failed to load protocol details:', error);
        }
    }

    function showProtocolModal(protocol) {
        const modal = document.getElementById('protocol-modal');

        // Set title and severity
        document.getElementById('modal-title').textContent = protocol.name;
        const severityEl = document.getElementById('modal-severity');
        severityEl.textContent = protocol.severity;
        severityEl.className = `severity ${protocol.severity}`;

        // Set summary
        document.getElementById('modal-summary').textContent = protocol.summary;

        // Handle anaphylaxis warning (for bee stings, allergic reactions)
        const anaphylaxisEl = document.getElementById('modal-anaphylaxis');
        if (protocol.anaphylaxis_escalation) {
            const escalation = protocol.anaphylaxis_escalation;
            document.getElementById('anaphylaxis-symptoms').innerHTML = `
                <h5>Watch for these symptoms:</h5>
                <ul>${escalation.symptoms.map(s => `<li>${s}</li>`).join('')}</ul>
            `;
            document.getElementById('anaphylaxis-actions').innerHTML = `
                <h5>IMMEDIATE ACTIONS:</h5>
                <ul>${escalation.immediate_actions.map(a => `<li>${a}</li>`).join('')}</ul>
            `;
            anaphylaxisEl.classList.remove('hidden');
        } else {
            anaphylaxisEl.classList.add('hidden');
        }

        // Render steps
        const stepsHtml = '<ol>' + protocol.steps.map(step => `
            <li>
                <strong>${step.summary}</strong>
                <span class="step-detail">${step.detail}</span>
            </li>
        `).join('') + '</ol>';
        document.getElementById('modal-steps').innerHTML = stepsHtml;

        // Render warnings
        const warningsEl = document.getElementById('modal-warnings');
        if (protocol.warnings && protocol.warnings.length > 0) {
            const warningsHtml = '<h4>‚ö†Ô∏è Warnings</h4><ul>' + protocol.warnings.map(w => `<li>${w}</li>`).join('') + '</ul>';
            warningsEl.innerHTML = warningsHtml;
            warningsEl.style.display = 'block';
        } else {
            warningsEl.style.display = 'none';
        }

        // Render contraindications
        const contraindicationsEl = document.getElementById('modal-contraindications');
        if (protocol.contraindications && protocol.contraindications.length > 0) {
            const contraHtml = '<h4>‚ùå Do NOT:</h4><ul>' + protocol.contraindications.map(c => `<li>${c}</li>`).join('') + '</ul>';
            contraindicationsEl.innerHTML = contraHtml;
            contraindicationsEl.classList.remove('hidden');
        } else {
            contraindicationsEl.classList.add('hidden');
        }

        // Render seek help
        document.getElementById('modal-seek-help').innerHTML = '<h4>üè• When to Seek Help</h4><p>' + protocol.when_to_seek_help + '</p>';

        modal.classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('protocol-modal').classList.add('hidden');
    }
</script>
{% endblock %}
