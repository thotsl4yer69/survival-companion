{% extends "base.html" %}

{% block title %}Survival Companion - Settings{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="card settings-section">
        <h2>User Profile</h2>
        <div class="setting-item">
            <span class="setting-label">Name</span>
            <input type="text" class="setting-input" id="user-name" placeholder="Enter name">
        </div>
        <div class="setting-item">
            <span class="setting-label">Blood Type</span>
            <select class="setting-select" id="blood-type">
                <option value="">Select...</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
            </select>
        </div>
        <div class="setting-item">
            <span class="setting-label">Allergies</span>
            <input type="text" class="setting-input" id="allergies" placeholder="e.g., Penicillin, Bees">
        </div>
        <div class="setting-item">
            <span class="setting-label">Medical Conditions</span>
            <input type="text" class="setting-input" id="conditions" placeholder="e.g., Diabetes, Asthma">
        </div>
        <div class="setting-item">
            <span class="setting-label">Current Medications</span>
            <input type="text" class="setting-input" id="medications" placeholder="e.g., Insulin, Albuterol">
        </div>
        <button class="btn btn-primary" id="save-profile">Save Profile</button>
    </div>

    <div class="card settings-section">
        <h2>Emergency Contacts</h2>
        <div id="emergency-contacts-list" class="emergency-contacts-list">
            <!-- Contacts will be loaded here -->
        </div>
        <div class="add-contact-form">
            <div class="setting-item contact-row">
                <input type="text" class="setting-input contact-input" id="contact-name" placeholder="Name">
            </div>
            <div class="setting-item contact-row">
                <input type="tel" class="setting-input contact-input" id="contact-phone" placeholder="Phone">
            </div>
            <div class="setting-item contact-row">
                <input type="text" class="setting-input contact-input" id="contact-relationship" placeholder="Relationship (optional)">
            </div>
            <button class="btn btn-secondary" id="add-contact">Add Contact</button>
        </div>
    </div>

    <div class="card settings-section">
        <h2>Baseline Vitals</h2>
        <p class="section-description">Set your normal resting vitals for health comparison</p>
        <div id="baseline-vitals-status" class="baseline-status">
            <!-- Status will be loaded here -->
        </div>
        <div class="setting-item">
            <span class="setting-label">Heart Rate</span>
            <div class="input-with-unit">
                <input type="number" class="setting-input vitals-input" id="baseline-hr" placeholder="72" min="30" max="200">
                <span class="unit">BPM</span>
            </div>
        </div>
        <div class="setting-item">
            <span class="setting-label">SpO2</span>
            <div class="input-with-unit">
                <input type="number" class="setting-input vitals-input" id="baseline-spo2" placeholder="98" min="70" max="100">
                <span class="unit">%</span>
            </div>
        </div>
        <div class="setting-item">
            <span class="setting-label">Temperature</span>
            <div class="input-with-unit">
                <input type="number" class="setting-input vitals-input" id="baseline-temp" placeholder="36.8" min="32" max="42" step="0.1">
                <span class="unit">°C</span>
            </div>
        </div>
        <div class="vitals-buttons">
            <button class="btn btn-primary" id="save-baselines">Save Baselines</button>
            <button class="btn btn-secondary" id="capture-baselines">Capture Current</button>
            <button class="btn btn-danger-outline" id="clear-baselines">Clear</button>
        </div>
        <div id="baseline-compare-result" class="compare-result hidden">
            <!-- Comparison results shown here -->
        </div>
    </div>

    <div class="card settings-section">
        <h2>Display</h2>
        <div class="setting-item toggle">
            <span class="setting-label">Night Mode</span>
            <label class="toggle-switch">
                <input type="checkbox" id="night-mode-toggle">
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="setting-item">
            <span class="setting-label">Font Size</span>
            <select class="setting-select" id="font-size">
                <option value="small">Small</option>
                <option value="medium" selected>Medium</option>
                <option value="large">Large</option>
            </select>
        </div>
        <div class="setting-item">
            <span class="setting-label">Screen Timeout</span>
            <select class="setting-select" id="screen-timeout">
                <option value="30">30 seconds</option>
                <option value="60" selected>1 minute</option>
                <option value="120">2 minutes</option>
                <option value="300">5 minutes</option>
                <option value="0">Never</option>
            </select>
        </div>
    </div>

    <div class="card settings-section">
        <h2>Voice</h2>
        <div class="setting-item">
            <span class="setting-label">Volume</span>
            <input type="range" class="setting-range" id="volume" min="0" max="100" value="80">
        </div>
        <div class="setting-item toggle">
            <span class="setting-label">Voice Feedback</span>
            <label class="toggle-switch">
                <input type="checkbox" id="voice-feedback" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>

    <div class="card settings-section">
        <h2>Sensors</h2>
        <div id="sensor-health-summary" class="sensor-health-summary">
            <!-- Health summary will be loaded here -->
        </div>
        <div class="sensor-status-list">
            <div class="sensor-row" id="sensor-row-gps">
                <div class="sensor-info">
                    <span class="sensor-name">GPS Module</span>
                    <span class="sensor-features" id="sensor-gps-features"></span>
                </div>
                <span class="sensor-status connected" id="sensor-gps">Checking...</span>
            </div>
            <div class="sensor-row" id="sensor-row-bme280">
                <div class="sensor-info">
                    <span class="sensor-name">BME280 (Environment)</span>
                    <span class="sensor-features" id="sensor-bme280-features"></span>
                </div>
                <span class="sensor-status connected" id="sensor-bme280">Checking...</span>
            </div>
            <div class="sensor-row" id="sensor-row-max30102">
                <div class="sensor-info">
                    <span class="sensor-name">MAX30102 (SpO2/HR)</span>
                    <span class="sensor-features" id="sensor-max30102-features"></span>
                </div>
                <span class="sensor-status connected" id="sensor-max30102">Checking...</span>
            </div>
            <div class="sensor-row" id="sensor-row-mlx90614">
                <div class="sensor-info">
                    <span class="sensor-name">MLX90614 (Temp)</span>
                    <span class="sensor-features" id="sensor-mlx90614-features"></span>
                </div>
                <span class="sensor-status connected" id="sensor-mlx90614">Checking...</span>
            </div>
            <div class="sensor-row" id="sensor-row-camera">
                <div class="sensor-info">
                    <span class="sensor-name">Camera</span>
                    <span class="sensor-features" id="sensor-camera-features"></span>
                </div>
                <span class="sensor-status connected" id="sensor-camera">Checking...</span>
            </div>
        </div>
        <div id="degraded-features" class="degraded-features hidden">
            <!-- Degraded features warning will appear here -->
        </div>
        <button class="btn btn-secondary" id="refresh-sensors">Refresh Sensor Status</button>
    </div>

    <div class="card settings-section">
        <h2>System</h2>
        <div class="system-info">
            <div class="info-row">
                <span class="info-label">Version</span>
                <span class="info-value">1.0.0</span>
            </div>
            <div class="info-row">
                <span class="info-label">LLM Model</span>
                <span class="info-value">Phi-3-mini</span>
            </div>
            <div class="info-row">
                <span class="info-label">Medical LLM</span>
                <span class="info-value">BioMistral-7B</span>
            </div>
        </div>
        <button class="btn btn-danger" id="factory-reset">Factory Reset</button>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .settings-container {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        padding-bottom: var(--spacing-xl);
    }

    .settings-section h2 {
        margin-bottom: var(--spacing-md);
    }

    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .setting-item:last-of-type {
        border-bottom: none;
    }

    .setting-label {
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
    }

    .setting-input,
    .setting-select {
        background: var(--bg-secondary);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        padding: var(--spacing-sm);
        font-size: var(--font-size-sm);
        width: 60%;
        text-align: right;
    }

    .setting-input:focus,
    .setting-select:focus {
        outline: none;
        border-color: var(--accent-secondary);
    }

    .setting-range {
        width: 60%;
        accent-color: var(--accent-secondary);
    }

    /* Toggle Switch */
    .toggle-switch {
        position: relative;
        width: 50px;
        height: 28px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--bg-secondary);
        transition: .3s;
        border-radius: 28px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 3px;
        bottom: 3px;
        background-color: var(--text-secondary);
        transition: .3s;
        border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
        background-color: var(--accent-secondary);
    }

    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(22px);
        background-color: white;
    }

    /* Sensor Health Summary */
    .sensor-health-summary {
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .sensor-health-summary.status-ok {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: var(--accent-primary);
    }

    .sensor-health-summary.status-degraded {
        background: rgba(255, 165, 0, 0.1);
        border: 1px solid rgba(255, 165, 0, 0.3);
        color: var(--accent-warning);
    }

    .sensor-health-summary.status-critical {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: var(--accent-danger);
    }

    .health-icon {
        font-size: 1.2em;
    }

    .health-text {
        font-size: var(--font-size-sm);
        flex: 1;
    }

    .health-percentage {
        font-weight: bold;
        font-size: var(--font-size-sm);
    }

    /* Sensor Status */
    .sensor-status-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
    }

    .sensor-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm);
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
        transition: background-color 0.3s ease;
    }

    .sensor-row.sensor-error {
        background: rgba(239, 68, 68, 0.1);
        border-left: 3px solid var(--accent-danger);
    }

    .sensor-row.sensor-warning {
        background: rgba(255, 165, 0, 0.1);
        border-left: 3px solid var(--accent-warning);
    }

    .sensor-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .sensor-name {
        font-size: var(--font-size-sm);
    }

    .sensor-features {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .sensor-status {
        font-size: var(--font-size-xs);
        padding: 2px 8px;
        border-radius: var(--radius-full);
    }

    .sensor-status.connected,
    .sensor-status.ok {
        background: rgba(34, 197, 94, 0.2);
        color: var(--accent-primary);
    }

    .sensor-status.disconnected,
    .sensor-status.error {
        background: rgba(239, 68, 68, 0.2);
        color: var(--accent-danger);
    }

    .sensor-status.warning {
        background: rgba(255, 165, 0, 0.2);
        color: var(--accent-warning);
    }

    /* Degraded Features Warning */
    .degraded-features {
        margin-top: var(--spacing-md);
        padding: var(--spacing-sm);
        background: rgba(255, 165, 0, 0.1);
        border: 1px solid rgba(255, 165, 0, 0.3);
        border-radius: var(--radius-sm);
    }

    .degraded-features.hidden {
        display: none;
    }

    .degraded-features-title {
        color: var(--accent-warning);
        font-weight: bold;
        font-size: var(--font-size-sm);
        margin-bottom: var(--spacing-xs);
    }

    .degraded-features-list {
        font-size: var(--font-size-xs);
        color: var(--text-secondary);
    }

    .degraded-feature-item {
        padding: 2px 0;
    }

    /* System Info */
    .system-info {
        margin-bottom: var(--spacing-md);
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: var(--spacing-xs) 0;
    }

    .info-label {
        color: var(--text-muted);
        font-size: var(--font-size-sm);
    }

    .info-value {
        font-size: var(--font-size-sm);
    }

    .btn {
        width: 100%;
        margin-top: var(--spacing-md);
    }

    /* Emergency Contacts */
    .emergency-contacts-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-md);
    }

    .contact-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm);
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
    }

    .contact-info {
        flex: 1;
    }

    .contact-name {
        font-weight: 600;
        font-size: var(--font-size-sm);
    }

    .contact-phone {
        font-size: var(--font-size-xs);
        color: var(--text-secondary);
    }

    .contact-relationship {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        font-style: italic;
    }

    .delete-contact-btn {
        background: rgba(239, 68, 68, 0.2);
        color: var(--accent-danger);
        border: none;
        border-radius: var(--radius-sm);
        padding: var(--spacing-xs) var(--spacing-sm);
        cursor: pointer;
        font-size: var(--font-size-xs);
    }

    .delete-contact-btn:hover {
        background: rgba(239, 68, 68, 0.4);
    }

    .add-contact-form {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: var(--spacing-md);
    }

    .contact-row {
        flex-direction: column;
        align-items: stretch;
        gap: var(--spacing-xs);
    }

    .contact-input {
        width: 100% !important;
        text-align: left !important;
        margin-bottom: var(--spacing-xs);
    }

    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .btn-secondary:hover {
        background: var(--accent-secondary);
    }

    .no-contacts {
        color: var(--text-muted);
        font-size: var(--font-size-sm);
        text-align: center;
        padding: var(--spacing-md);
    }

    /* Baseline Vitals Section */
    .section-description {
        color: var(--text-muted);
        font-size: var(--font-size-xs);
        margin-bottom: var(--spacing-md);
    }

    .baseline-status {
        margin-bottom: var(--spacing-md);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        font-size: var(--font-size-sm);
    }

    .baseline-status.has-baselines {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: var(--accent-primary);
    }

    .baseline-status.no-baselines {
        background: rgba(255, 165, 0, 0.1);
        border: 1px solid rgba(255, 165, 0, 0.3);
        color: var(--accent-warning);
    }

    .input-with-unit {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        width: 60%;
    }

    .input-with-unit .setting-input {
        width: 100%;
    }

    .input-with-unit .unit {
        color: var(--text-muted);
        font-size: var(--font-size-xs);
        min-width: 30px;
    }

    .vitals-input {
        text-align: right;
    }

    .vitals-buttons {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
    }

    .vitals-buttons .btn {
        flex: 1;
        margin-top: 0;
    }

    .btn-danger-outline {
        background: transparent;
        color: var(--accent-danger);
        border: 1px solid var(--accent-danger);
    }

    .btn-danger-outline:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    .compare-result {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
    }

    .compare-result.hidden {
        display: none;
    }

    .compare-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-xs) 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .compare-item:last-child {
        border-bottom: none;
    }

    .compare-metric {
        font-size: var(--font-size-sm);
    }

    .compare-values {
        text-align: right;
    }

    .compare-current {
        font-weight: bold;
    }

    .compare-baseline {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }

    .compare-status {
        font-size: var(--font-size-xs);
        padding: 2px 8px;
        border-radius: var(--radius-full);
    }

    .compare-status.normal {
        background: rgba(34, 197, 94, 0.2);
        color: var(--accent-primary);
    }

    .compare-status.elevated,
    .compare-status.attention {
        background: rgba(255, 165, 0, 0.2);
        color: var(--accent-warning);
    }

    .compare-status.concerning,
    .compare-status.fever,
    .compare-status.hypothermia,
    .compare-status.critical {
        background: rgba(239, 68, 68, 0.2);
        color: var(--accent-danger);
    }

    .baseline-recorded {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-top: var(--spacing-xs);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Night mode toggle
        const nightModeToggle = document.getElementById('night-mode-toggle');
        nightModeToggle.checked = document.body.classList.contains('night-mode');

        nightModeToggle.addEventListener('change', function() {
            toggleNightMode();
        });

        // Font size select
        const fontSizeSelect = document.getElementById('font-size');
        // Set current value from localStorage
        const currentFontSize = localStorage.getItem('fontSize') || 'medium';
        fontSizeSelect.value = currentFontSize;

        fontSizeSelect.addEventListener('change', function() {
            setFontSize(this.value);
        });

        // Load profile from server API
        loadProfile();

        // Save profile to server API
        document.getElementById('save-profile').addEventListener('click', saveProfile);

        // Add emergency contact
        document.getElementById('add-contact').addEventListener('click', addEmergencyContact);

        // Factory reset
        document.getElementById('factory-reset').addEventListener('click', function() {
            if (confirm('Are you sure you want to reset all settings? This cannot be undone.')) {
                localStorage.clear();
                alert('Settings reset. Reloading...');
                location.reload();
            }
        });

        // Load sensor status
        loadSensorStatus();
    });

    // Load profile from server
    async function loadProfile() {
        try {
            const response = await fetch('/api/profile');
            const data = await response.json();

            if (data.success && data.profile) {
                const profile = data.profile;
                document.getElementById('user-name').value = profile.name || '';
                document.getElementById('blood-type').value = profile.blood_type || '';
                document.getElementById('allergies').value = (profile.allergies || []).join(', ');
                document.getElementById('conditions').value = (profile.medical_conditions || []).join(', ');
                document.getElementById('medications').value = (profile.medications || []).join(', ');

                // Render emergency contacts
                renderEmergencyContacts(profile.emergency_contacts || []);
            }
        } catch (error) {
            console.error('Error loading profile:', error);
            // Fall back to localStorage
            const savedProfile = localStorage.getItem('userProfile');
            if (savedProfile) {
                const profile = JSON.parse(savedProfile);
                document.getElementById('user-name').value = profile.name || '';
                document.getElementById('blood-type').value = profile.bloodType || '';
                document.getElementById('allergies').value = profile.allergies || '';
                document.getElementById('conditions').value = profile.conditions || '';
                document.getElementById('medications').value = profile.medications || '';
            }
        }
    }

    // Save profile to server
    async function saveProfile() {
        const allergiesText = document.getElementById('allergies').value;
        const conditionsText = document.getElementById('conditions').value;
        const medicationsText = document.getElementById('medications').value;

        const profile = {
            name: document.getElementById('user-name').value,
            blood_type: document.getElementById('blood-type').value,
            allergies: allergiesText ? allergiesText.split(',').map(s => s.trim()).filter(Boolean) : [],
            medical_conditions: conditionsText ? conditionsText.split(',').map(s => s.trim()).filter(Boolean) : [],
            medications: medicationsText ? medicationsText.split(',').map(s => s.trim()).filter(Boolean) : []
        };

        try {
            const response = await fetch('/api/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(profile)
            });

            const data = await response.json();

            if (data.success) {
                // Also save to localStorage as backup
                localStorage.setItem('userProfile', JSON.stringify(profile));
                alert('Profile saved successfully!');
            } else {
                alert('Error saving profile: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error saving profile:', error);
            // Fall back to localStorage
            localStorage.setItem('userProfile', JSON.stringify(profile));
            alert('Profile saved locally (server unavailable)');
        }
    }

    // Render emergency contacts list
    function renderEmergencyContacts(contacts) {
        const container = document.getElementById('emergency-contacts-list');

        if (!contacts || contacts.length === 0) {
            container.innerHTML = '<div class="no-contacts">No emergency contacts added</div>';
            return;
        }

        container.innerHTML = contacts.map((contact, index) => `
            <div class="contact-item">
                <div class="contact-info">
                    <div class="contact-name">${escapeHtml(contact.name)}</div>
                    <div class="contact-phone">${escapeHtml(contact.phone)}</div>
                    ${contact.relationship ? `<div class="contact-relationship">${escapeHtml(contact.relationship)}</div>` : ''}
                </div>
                <button class="delete-contact-btn" onclick="deleteEmergencyContact(${index})">Delete</button>
            </div>
        `).join('');
    }

    // Add emergency contact
    async function addEmergencyContact() {
        const name = document.getElementById('contact-name').value.trim();
        const phone = document.getElementById('contact-phone').value.trim();
        const relationship = document.getElementById('contact-relationship').value.trim();

        if (!name || !phone) {
            alert('Please enter a name and phone number');
            return;
        }

        try {
            const response = await fetch('/api/profile/emergency-contacts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, phone, relationship })
            });

            const data = await response.json();

            if (data.success) {
                // Clear the form
                document.getElementById('contact-name').value = '';
                document.getElementById('contact-phone').value = '';
                document.getElementById('contact-relationship').value = '';

                // Reload contacts
                renderEmergencyContacts(data.emergency_contacts);
            } else {
                alert('Error adding contact: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error adding contact:', error);
            alert('Error adding contact');
        }
    }

    // Delete emergency contact
    async function deleteEmergencyContact(index) {
        if (!confirm('Are you sure you want to delete this contact?')) {
            return;
        }

        try {
            const response = await fetch(`/api/profile/emergency-contacts/${index}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                renderEmergencyContacts(data.emergency_contacts);
            } else {
                alert('Error deleting contact: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error deleting contact:', error);
            alert('Error deleting contact');
        }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function loadSensorStatus() {
        try {
            const response = await fetch('/api/sensors/health');
            const data = await response.json();

            if (data.success) {
                // Update health summary
                updateHealthSummary(data.summary);

                // Update individual sensors
                for (const [sensorName, sensorInfo] of Object.entries(data.sensors)) {
                    updateSensorRow(sensorName, sensorInfo);
                }

                // Update degraded features warning
                updateDegradedFeatures(data.degraded_features);
            }
        } catch (error) {
            console.error('Error loading sensor health:', error);
            // Fall back to basic status API
            loadBasicSensorStatus();
        }
    }

    async function loadBasicSensorStatus() {
        const status = await fetch('/api/status').then(r => r.json());

        if (status && status.sensors) {
            updateSensorStatusBasic('sensor-max30102', status.sensors.max30102);
            updateSensorStatusBasic('sensor-mlx90614', status.sensors.mlx90614);
            updateSensorStatusBasic('sensor-bme280', status.sensors.bme280);
            updateSensorStatusBasic('sensor-gps', status.sensors.gps);
            updateSensorStatusBasic('sensor-camera', status.sensors.camera);
        }
    }

    function updateHealthSummary(summary) {
        const summaryEl = document.getElementById('sensor-health-summary');
        if (!summaryEl) return;

        let icon = '✓';
        let text = 'All sensors operational';
        let statusClass = 'status-ok';

        if (summary.overall_status === 'degraded') {
            icon = '⚠';
            text = `${summary.sensors_error} sensor(s) offline - some features limited`;
            statusClass = 'status-degraded';
        } else if (summary.overall_status === 'critical') {
            icon = '✕';
            text = `${summary.sensors_error} sensors offline - functionality severely limited`;
            statusClass = 'status-critical';
        }

        summaryEl.innerHTML = `
            <span class="health-icon">${icon}</span>
            <span class="health-text">${text}</span>
            <span class="health-percentage">${summary.health_percentage}%</span>
        `;
        summaryEl.className = `sensor-health-summary ${statusClass}`;
    }

    function updateSensorRow(sensorName, sensorInfo) {
        const statusEl = document.getElementById(`sensor-${sensorName}`);
        const rowEl = document.getElementById(`sensor-row-${sensorName}`);
        const featuresEl = document.getElementById(`sensor-${sensorName}-features`);

        if (statusEl) {
            if (sensorInfo.status === 'ok') {
                statusEl.textContent = 'OK';
                statusEl.className = 'sensor-status ok';
            } else if (sensorInfo.status === 'warning') {
                statusEl.textContent = 'Warning';
                statusEl.className = 'sensor-status warning';
            } else {
                statusEl.textContent = 'Error';
                statusEl.className = 'sensor-status error';
            }
        }

        if (rowEl) {
            rowEl.className = 'sensor-row';
            if (sensorInfo.status === 'error') {
                rowEl.classList.add('sensor-error');
            } else if (sensorInfo.status === 'warning') {
                rowEl.classList.add('sensor-warning');
            }
        }

        if (featuresEl && sensorInfo.features_affected) {
            const features = sensorInfo.features_affected.slice(0, 2).join(', ');
            featuresEl.textContent = features + (sensorInfo.features_affected.length > 2 ? '...' : '');
            featuresEl.title = sensorInfo.features_affected.join(', ');
        }
    }

    function updateDegradedFeatures(features) {
        const degradedEl = document.getElementById('degraded-features');
        if (!degradedEl) return;

        if (!features || features.length === 0) {
            degradedEl.classList.add('hidden');
            return;
        }

        degradedEl.innerHTML = `
            <div class="degraded-features-title">⚠ Degraded Features</div>
            <div class="degraded-features-list">
                ${features.map(f => `<div class="degraded-feature-item">• ${f}</div>`).join('')}
            </div>
        `;
        degradedEl.classList.remove('hidden');
    }

    function updateSensorStatusBasic(elementId, isConnected) {
        const el = document.getElementById(elementId);
        if (el) {
            el.textContent = isConnected ? 'OK' : 'Error';
            el.className = 'sensor-status ' + (isConnected ? 'ok' : 'error');
        }
    }

    // Add refresh button handler
    document.getElementById('refresh-sensors').addEventListener('click', loadSensorStatus);

    // ====================================
    // Baseline Vitals Management
    // ====================================

    // Load baseline vitals on page load
    loadBaselineVitals();

    // Setup button handlers
    document.getElementById('save-baselines').addEventListener('click', saveBaselineVitals);
    document.getElementById('capture-baselines').addEventListener('click', captureBaselineVitals);
    document.getElementById('clear-baselines').addEventListener('click', clearBaselineVitals);

    // Load baseline vitals from server
    async function loadBaselineVitals() {
        try {
            const response = await fetch('/api/profile/baseline-vitals');
            const data = await response.json();

            if (data.success) {
                const vitals = data.baseline_vitals;
                const statusEl = document.getElementById('baseline-vitals-status');

                // Populate input fields
                if (vitals.heart_rate !== null) {
                    document.getElementById('baseline-hr').value = vitals.heart_rate;
                }
                if (vitals.spo2 !== null) {
                    document.getElementById('baseline-spo2').value = vitals.spo2;
                }
                if (vitals.temperature !== null) {
                    document.getElementById('baseline-temp').value = vitals.temperature;
                }

                // Update status display
                if (data.has_baselines) {
                    const recordedAt = vitals.recorded_at ?
                        new Date(vitals.recorded_at).toLocaleString() : 'Unknown';
                    statusEl.innerHTML = `✓ Baselines set on ${recordedAt}`;
                    statusEl.className = 'baseline-status has-baselines';

                    // Auto-show comparison
                    loadVitalsComparison();
                } else {
                    statusEl.innerHTML = '⚠ No baselines set - readings cannot be compared to your normal';
                    statusEl.className = 'baseline-status no-baselines';
                }
            }
        } catch (error) {
            console.error('Error loading baselines:', error);
        }
    }

    // Save baseline vitals
    async function saveBaselineVitals() {
        const hrValue = document.getElementById('baseline-hr').value;
        const spo2Value = document.getElementById('baseline-spo2').value;
        const tempValue = document.getElementById('baseline-temp').value;

        if (!hrValue && !spo2Value && !tempValue) {
            alert('Please enter at least one baseline value');
            return;
        }

        const baselines = {};
        if (hrValue) baselines.heart_rate = parseFloat(hrValue);
        if (spo2Value) baselines.spo2 = parseFloat(spo2Value);
        if (tempValue) baselines.temperature = parseFloat(tempValue);

        try {
            const response = await fetch('/api/profile/baseline-vitals', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(baselines)
            });

            const data = await response.json();

            if (data.success) {
                alert('Baseline vitals saved successfully!');
                loadBaselineVitals();
            } else {
                if (data.errors) {
                    alert('Validation errors:\n' + data.errors.join('\n'));
                } else {
                    alert('Error saving baselines');
                }
            }
        } catch (error) {
            console.error('Error saving baselines:', error);
            alert('Error saving baselines');
        }
    }

    // Capture baselines from current sensor readings
    async function captureBaselineVitals() {
        if (!confirm('This will set your baseline vitals from your current sensor readings. Continue?')) {
            return;
        }

        try {
            const response = await fetch('/api/profile/baseline-vitals/capture', {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                const captured = data.captured_from;
                alert(`Baselines captured:\n` +
                      `Heart Rate: ${captured.heart_rate} BPM\n` +
                      `SpO2: ${captured.spo2}%\n` +
                      `Temperature: ${captured.temperature}°C`);
                loadBaselineVitals();
            } else {
                alert('Error capturing baselines');
            }
        } catch (error) {
            console.error('Error capturing baselines:', error);
            alert('Error capturing baselines');
        }
    }

    // Clear baseline vitals
    async function clearBaselineVitals() {
        if (!confirm('Are you sure you want to clear all baseline vitals?')) {
            return;
        }

        try {
            const response = await fetch('/api/profile/baseline-vitals', {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                // Clear input fields
                document.getElementById('baseline-hr').value = '';
                document.getElementById('baseline-spo2').value = '';
                document.getElementById('baseline-temp').value = '';

                // Hide comparison
                document.getElementById('baseline-compare-result').classList.add('hidden');

                loadBaselineVitals();
                alert('Baseline vitals cleared');
            } else {
                alert('Error clearing baselines');
            }
        } catch (error) {
            console.error('Error clearing baselines:', error);
            alert('Error clearing baselines');
        }
    }

    // Load vitals comparison
    async function loadVitalsComparison() {
        try {
            const response = await fetch('/api/vitals/compare');
            const data = await response.json();

            const resultEl = document.getElementById('baseline-compare-result');

            if (!data.success || !data.has_baselines) {
                resultEl.classList.add('hidden');
                return;
            }

            // Build comparison HTML
            let html = '<h3 style="margin-bottom: var(--spacing-sm); font-size: var(--font-size-sm);">Current vs Baseline</h3>';

            data.comparisons.forEach(comp => {
                const directionIcon = comp.direction === 'above' ? '↑' :
                                     comp.direction === 'below' ? '↓' : '=';
                html += `
                    <div class="compare-item">
                        <span class="compare-metric">${comp.label}</span>
                        <div class="compare-values">
                            <span class="compare-current">${comp.current} ${comp.unit}</span>
                            <span class="compare-baseline">(baseline: ${comp.baseline})</span>
                            <span class="compare-status ${comp.status}">${directionIcon} ${comp.status}</span>
                        </div>
                    </div>
                `;
            });

            if (data.alerts && data.alerts.length > 0) {
                html += '<div style="margin-top: var(--spacing-sm);">';
                data.alerts.forEach(alert => {
                    const alertClass = alert.type === 'danger' ? 'critical' : 'elevated';
                    html += `<div class="compare-status ${alertClass}" style="display: block; margin-bottom: var(--spacing-xs);">${alert.message}</div>`;
                });
                html += '</div>';
            }

            if (data.baseline_recorded_at) {
                html += `<div class="baseline-recorded">Baseline recorded: ${new Date(data.baseline_recorded_at).toLocaleString()}</div>`;
            }

            resultEl.innerHTML = html;
            resultEl.classList.remove('hidden');
        } catch (error) {
            console.error('Error loading comparison:', error);
        }
    }
</script>
{% endblock %}
