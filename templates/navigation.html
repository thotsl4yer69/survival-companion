{% extends "base.html" %}

{% block title %}Survival Companion - Navigation{% endblock %}

{% block content %}
<div class="navigation-container">
    <div class="map-placeholder">
        <div class="map-content">
            <svg viewBox="0 0 24 24" fill="currentColor" class="map-icon">
                <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>
            </svg>
            <p>Offline Map View</p>
            <span class="map-note">Maps require MBTiles download</span>
        </div>
    </div>

    <div class="nav-info-panel">
        <div class="position-card">
            <h3>Current Position <span id="gps-accuracy-badge" class="accuracy-badge accuracy-high">●</span></h3>
            <div class="coords-display">
                <div class="coord">
                    <span class="coord-label">LAT</span>
                    <span class="coord-value" id="nav-lat">-33.8688°</span>
                </div>
                <div class="coord">
                    <span class="coord-label">LON</span>
                    <span class="coord-value" id="nav-lon">151.2093°</span>
                </div>
                <div class="coord">
                    <span class="coord-label">ALT</span>
                    <span class="coord-value" id="nav-alt">58 m</span>
                </div>
            </div>
            <div class="accuracy-display">
                <span class="accuracy-label">Accuracy:</span>
                <span class="accuracy-value" id="nav-accuracy">±3.5 m</span>
                <span class="accuracy-indicator" id="nav-accuracy-indicator">(high)</span>
            </div>
        </div>

        <div class="nav-actions">
            <button class="nav-btn" id="mark-waypoint">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
                Mark Waypoint
            </button>
            <button class="nav-btn" id="start-breadcrumbs">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
                Start Trail
            </button>
            <button class="nav-btn emergency" id="im-lost">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                I'm Lost
            </button>
        </div>

        <div class="compass-widget">
            <div class="compass-ring">
                <div class="compass-needle" id="compass-needle">
                    <div class="needle-n">N</div>
                </div>
            </div>
            <div class="compass-heading">
                <span id="heading-value">0</span>°
            </div>
        </div>

        <!-- Navigation Target Panel (hidden by default) -->
        <div id="navigation-panel" class="navigation-panel hidden">
            <h3>Navigating to: <span id="nav-target-name">--</span></h3>
            <div class="navigation-info">
                <div class="nav-stat">
                    <span class="nav-stat-label">Distance</span>
                    <span class="nav-stat-value" id="nav-distance">-- m</span>
                </div>
                <div class="nav-stat">
                    <span class="nav-stat-label">Bearing</span>
                    <span class="nav-stat-value" id="nav-bearing">--°</span>
                </div>
                <div class="nav-stat">
                    <span class="nav-stat-label">Direction</span>
                    <span class="nav-stat-value" id="nav-direction">--</span>
                </div>
            </div>
            <div class="nav-compass-arrow">
                <div id="nav-arrow" class="arrow">↑</div>
                <span class="arrow-hint">Point this direction</span>
            </div>
            <button id="stop-navigation" class="btn btn-danger">Stop Navigation</button>
        </div>

        <!-- I'm Lost Emergency Panel (hidden by default) -->
        <div id="lost-mode-panel" class="lost-mode-panel hidden">
            <div class="lost-mode-header">
                <svg viewBox="0 0 24 24" fill="currentColor" class="lost-icon">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <h3>I'M LOST - STAY CALM</h3>
            </div>

            <div class="lost-mode-message">
                <p id="lost-ack-message">Acknowledged. The system is analyzing your situation...</p>
            </div>

            <div class="lost-mode-guidance">
                <h4>Guidance Steps</h4>
                <div id="lost-guidance-steps" class="guidance-steps">
                    <!-- Steps will be populated dynamically -->
                </div>
            </div>

            <div class="lost-mode-waypoints">
                <h4>Nearest Waypoints</h4>
                <div id="lost-waypoints-list" class="lost-waypoints-list">
                    <p class="no-waypoints">No waypoints saved</p>
                </div>
            </div>

            <div class="lost-mode-backtrack">
                <h4>Backtrack Route</h4>
                <div id="lost-backtrack-info" class="backtrack-info">
                    <p>Checking for breadcrumb trail...</p>
                </div>
                <button id="start-backtrack" class="btn btn-primary hidden">Start Backtracking</button>
            </div>

            <div class="lost-mode-tips">
                <h4>Survival Tips</h4>
                <ul id="lost-tips-list">
                    <li>Stay hydrated</li>
                    <li>Stay in shade during hot hours</li>
                    <li>Do not wander aimlessly</li>
                </ul>
            </div>

            <div class="lost-mode-actions">
                <button id="exit-lost-mode" class="btn btn-secondary">I'm Safe - Exit Mode</button>
                <button id="activate-sos" class="btn btn-danger">Activate SOS Beacon</button>
            </div>
        </div>

        <!-- Waypoints List -->
        <div class="waypoints-card">
            <h3>Saved Waypoints <span id="waypoint-count" class="waypoint-count">(0)</span></h3>
            <div id="waypoints-list" class="waypoints-list">
                <p class="no-waypoints">No waypoints saved yet</p>
            </div>
        </div>
    </div>
</div>

<!-- Waypoint Dialog -->
<div id="waypoint-dialog" class="dialog-overlay hidden">
    <div class="dialog-content">
        <h3>Mark Waypoint</h3>
        <form id="waypoint-form">
            <div class="form-group">
                <label for="waypoint-name">Name *</label>
                <input type="text" id="waypoint-name" placeholder="Enter waypoint name" required>
            </div>
            <div class="form-group">
                <label for="waypoint-category">Category</label>
                <select id="waypoint-category">
                    <option value="camp">Camp</option>
                    <option value="water">Water Source</option>
                    <option value="danger">Danger</option>
                    <option value="landmark">Landmark</option>
                    <option value="general" selected>General</option>
                </select>
            </div>
            <div class="form-group">
                <label for="waypoint-notes">Notes</label>
                <textarea id="waypoint-notes" placeholder="Optional notes"></textarea>
            </div>
            <div class="form-group position-preview">
                <span class="position-label">Position:</span>
                <span id="dialog-position" class="position-value">--.-----°, --.-----°</span>
            </div>
            <div class="dialog-actions">
                <button type="button" class="btn btn-secondary" id="cancel-waypoint">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Waypoint</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .navigation-container {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        height: calc(100vh - var(--status-bar-height) - var(--nav-bar-height) - 40px);
    }

    .map-placeholder {
        flex: 1;
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 200px;
    }

    .map-content {
        text-align: center;
        color: var(--text-secondary);
    }

    .map-icon {
        width: 64px;
        height: 64px;
        opacity: 0.5;
        margin-bottom: var(--spacing-sm);
    }

    .map-note {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        display: block;
        margin-top: var(--spacing-xs);
    }

    .nav-info-panel {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .position-card {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
    }

    .position-card h3 {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        margin-bottom: var(--spacing-sm);
    }

    .coords-display {
        display: flex;
        justify-content: space-between;
    }

    .coord {
        text-align: center;
    }

    .coord-label {
        display: block;
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-bottom: var(--spacing-xs);
    }

    .coord-value {
        font-family: monospace;
        font-size: var(--font-size-base);
        font-weight: 600;
        color: var(--accent-secondary);
    }

    .nav-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    .nav-btn {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-sm);
        background: var(--bg-card);
        border: none;
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: var(--font-size-xs);
        cursor: pointer;
        min-height: var(--touch-preferred);
        transition: background 0.2s;
    }

    .nav-btn:active {
        background: var(--bg-hover);
    }

    .nav-btn svg {
        width: 24px;
        height: 24px;
        margin-bottom: var(--spacing-xs);
        color: var(--accent-secondary);
    }

    .nav-btn.emergency svg {
        color: var(--accent-danger);
    }

    .compass-widget {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
    }

    .compass-ring {
        width: 80px;
        height: 80px;
        border: 2px solid var(--text-muted);
        border-radius: 50%;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .compass-needle {
        width: 60px;
        height: 60px;
        position: relative;
        transition: transform 0.3s ease;
    }

    .needle-n {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        font-weight: 700;
        color: var(--accent-danger);
        font-size: var(--font-size-sm);
    }

    .compass-heading {
        font-size: var(--font-size-2xl);
        font-weight: 700;
        font-family: monospace;
    }

    .accuracy-display {
        margin-top: var(--spacing-sm);
        padding-top: var(--spacing-sm);
        border-top: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--font-size-sm);
    }

    .accuracy-label {
        color: var(--text-muted);
    }

    .accuracy-value {
        font-family: monospace;
        font-weight: 600;
        color: var(--text-primary);
    }

    .accuracy-indicator {
        font-size: var(--font-size-xs);
    }

    .accuracy-indicator.high {
        color: var(--success, #00ff00);
    }

    .accuracy-indicator.medium {
        color: var(--warning, #ffa500);
    }

    .accuracy-indicator.low {
        color: var(--accent-danger, #ff0000);
    }

    .accuracy-badge {
        font-size: var(--font-size-xs);
        margin-left: var(--spacing-xs);
    }

    .accuracy-badge.accuracy-high {
        color: var(--success, #00ff00);
    }

    .accuracy-badge.accuracy-medium {
        color: var(--warning, #ffa500);
    }

    .accuracy-badge.accuracy-low {
        color: var(--accent-danger, #ff0000);
    }

    .gps-update-indicator {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-left: auto;
    }

    .gps-update-indicator.updating {
        color: var(--accent-primary);
    }

    /* Waypoints Card */
    .waypoints-card {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
    }

    .waypoints-card h3 {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        margin-bottom: var(--spacing-sm);
    }

    .waypoint-count {
        color: var(--text-muted);
        font-weight: normal;
    }

    .waypoints-list {
        max-height: 150px;
        overflow-y: auto;
    }

    .no-waypoints {
        color: var(--text-muted);
        font-size: var(--font-size-sm);
        text-align: center;
        padding: var(--spacing-md);
    }

    .waypoint-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-sm);
        border-bottom: 1px solid var(--border-color);
    }

    .waypoint-item:last-child {
        border-bottom: none;
    }

    .waypoint-info {
        flex: 1;
    }

    .waypoint-name {
        font-weight: 600;
        font-size: var(--font-size-sm);
    }

    .waypoint-coords {
        font-family: monospace;
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }

    .waypoint-category {
        font-size: var(--font-size-xs);
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        background: var(--bg-hover);
        color: var(--text-secondary);
        margin-left: var(--spacing-xs);
    }

    .waypoint-delete {
        background: transparent;
        border: none;
        color: var(--accent-danger);
        cursor: pointer;
        padding: var(--spacing-xs);
    }

    /* Dialog */
    .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .dialog-overlay.hidden {
        display: none;
    }

    .dialog-content {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        width: 90%;
        max-width: 400px;
    }

    .dialog-content h3 {
        margin-bottom: var(--spacing-md);
        color: var(--text-primary);
    }

    .form-group {
        margin-bottom: var(--spacing-md);
    }

    .form-group label {
        display: block;
        margin-bottom: var(--spacing-xs);
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: var(--spacing-sm);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background: var(--bg-main);
        color: var(--text-primary);
        font-size: var(--font-size-base);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 60px;
    }

    .position-preview {
        background: var(--bg-hover);
        padding: var(--spacing-sm);
        border-radius: var(--radius-md);
    }

    .position-label {
        color: var(--text-muted);
        font-size: var(--font-size-sm);
    }

    .position-value {
        font-family: monospace;
        color: var(--accent-secondary);
        font-weight: 600;
    }

    .dialog-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
    }

    .dialog-actions .btn {
        flex: 1;
        padding: var(--spacing-sm) var(--spacing-md);
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: var(--font-size-base);
    }

    .btn-primary {
        background: var(--accent-primary);
        color: white;
    }

    .btn-secondary {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .btn-danger {
        background: var(--accent-danger, #ff0000);
        color: white;
    }

    /* Navigation Panel */
    .navigation-panel {
        background: linear-gradient(135deg, var(--bg-card), var(--accent-primary-transparent, rgba(0, 100, 200, 0.2)));
        border: 2px solid var(--accent-primary, #0066cc);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
    }

    .navigation-panel.hidden {
        display: none;
    }

    .navigation-panel h3 {
        color: var(--accent-primary, #0066cc);
        margin-bottom: var(--spacing-md);
        font-size: var(--font-size-base);
    }

    #nav-target-name {
        color: var(--text-primary);
        font-weight: 700;
    }

    .navigation-info {
        display: flex;
        justify-content: space-around;
        margin-bottom: var(--spacing-md);
    }

    .nav-stat {
        text-align: center;
    }

    .nav-stat-label {
        display: block;
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-bottom: var(--spacing-xs);
    }

    .nav-stat-value {
        font-family: monospace;
        font-size: var(--font-size-lg);
        font-weight: 700;
        color: var(--accent-secondary);
    }

    .nav-compass-arrow {
        text-align: center;
        margin-bottom: var(--spacing-md);
    }

    .arrow {
        font-size: 48px;
        color: var(--accent-primary);
        transition: transform 0.3s ease;
        line-height: 1;
    }

    .arrow-hint {
        display: block;
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-top: var(--spacing-xs);
    }

    /* Waypoint item with navigate button */
    .waypoint-actions {
        display: flex;
        gap: var(--spacing-xs);
    }

    .waypoint-navigate {
        background: var(--accent-primary);
        border: none;
        color: white;
        cursor: pointer;
        padding: var(--spacing-xs);
        border-radius: var(--radius-sm);
        font-size: var(--font-size-xs);
    }

    .waypoint-navigate:hover {
        opacity: 0.9;
    }

    /* I'm Lost Emergency Mode Panel */
    .lost-mode-panel {
        background: linear-gradient(135deg, var(--bg-card), rgba(255, 0, 0, 0.15));
        border: 3px solid var(--accent-danger, #ff0000);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        animation: pulse-border 2s infinite;
    }

    .lost-mode-panel.hidden {
        display: none;
    }

    @keyframes pulse-border {
        0%, 100% {
            border-color: var(--accent-danger, #ff0000);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }
        50% {
            border-color: rgba(255, 0, 0, 0.6);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }
    }

    .lost-mode-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
        padding-bottom: var(--spacing-sm);
        border-bottom: 2px solid var(--accent-danger, #ff0000);
    }

    .lost-icon {
        width: 32px;
        height: 32px;
        color: var(--accent-danger, #ff0000);
        animation: pulse-icon 1.5s infinite;
    }

    @keyframes pulse-icon {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.1); }
    }

    .lost-mode-header h3 {
        color: var(--accent-danger, #ff0000);
        font-size: var(--font-size-lg);
        font-weight: 700;
        margin: 0;
        letter-spacing: 1px;
    }

    .lost-mode-message {
        background: rgba(0, 0, 0, 0.3);
        border-radius: var(--radius-md);
        padding: var(--spacing-sm) var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }

    .lost-mode-message p {
        color: var(--text-primary);
        font-size: var(--font-size-base);
        margin: 0;
    }

    .lost-mode-guidance,
    .lost-mode-waypoints,
    .lost-mode-backtrack,
    .lost-mode-tips {
        margin-bottom: var(--spacing-md);
    }

    .lost-mode-guidance h4,
    .lost-mode-waypoints h4,
    .lost-mode-backtrack h4,
    .lost-mode-tips h4 {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        margin-bottom: var(--spacing-xs);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .guidance-steps {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
    }

    .guidance-step {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-sm);
        background: rgba(255, 255, 255, 0.05);
        border-radius: var(--radius-md);
        padding: var(--spacing-sm);
    }

    .guidance-step-number {
        background: var(--accent-primary);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: var(--font-size-sm);
        flex-shrink: 0;
    }

    .guidance-step-content {
        flex: 1;
    }

    .guidance-step-action {
        font-weight: 600;
        color: var(--text-primary);
        font-size: var(--font-size-sm);
        margin-bottom: 2px;
    }

    .guidance-step-detail {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }

    .lost-waypoints-list {
        max-height: 120px;
        overflow-y: auto;
    }

    .lost-waypoint-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-xs) var(--spacing-sm);
        background: rgba(255, 255, 255, 0.05);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-xs);
    }

    .lost-waypoint-name {
        font-weight: 600;
        font-size: var(--font-size-sm);
        color: var(--text-primary);
    }

    .lost-waypoint-distance {
        font-family: monospace;
        font-size: var(--font-size-sm);
        color: var(--accent-secondary);
    }

    .lost-waypoint-direction {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }

    .backtrack-info {
        background: rgba(0, 100, 200, 0.15);
        border: 1px solid var(--accent-primary);
        border-radius: var(--radius-md);
        padding: var(--spacing-sm);
    }

    .backtrack-info p {
        margin: 0;
        font-size: var(--font-size-sm);
        color: var(--text-primary);
    }

    .backtrack-available {
        border-color: var(--success, #00ff00);
        background: rgba(0, 255, 0, 0.1);
    }

    .backtrack-unavailable {
        border-color: var(--warning, #ffa500);
        background: rgba(255, 165, 0, 0.1);
    }

    .backtrack-trail-name {
        font-weight: 600;
        color: var(--accent-primary);
    }

    .backtrack-stats {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-xs);
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }

    .lost-mode-tips ul {
        margin: 0;
        padding-left: var(--spacing-md);
    }

    .lost-mode-tips li {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        margin-bottom: var(--spacing-xs);
    }

    .lost-mode-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--border-color);
    }

    .lost-mode-actions .btn {
        flex: 1;
        padding: var(--spacing-sm) var(--spacing-md);
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: var(--font-size-base);
        font-weight: 600;
        min-height: var(--touch-preferred);
    }

    #activate-sos {
        animation: sos-pulse 1s infinite;
    }

    @keyframes sos-pulse {
        0%, 100% { background: var(--accent-danger, #ff0000); }
        50% { background: rgba(255, 0, 0, 0.7); }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // GPS polling interval handle
    let gpsPollingInterval = null;
    let lastGpsPosition = null;
    const GPS_POLL_INTERVAL = 1000; // Poll every 1 second for real-time updates

    document.addEventListener('DOMContentLoaded', function() {
        // Load initial GPS data
        loadGPSPosition();

        // Start real-time GPS polling
        startGPSPolling();

        // Update compass from GPS heading
        setInterval(() => {
            if (lastGpsPosition && lastGpsPosition.heading !== undefined) {
                document.getElementById('compass-needle').style.transform = `rotate(${lastGpsPosition.heading}deg)`;
                document.getElementById('heading-value').textContent = Math.round(lastGpsPosition.heading);
            }
        }, 500);
    });

    // Start GPS tracking and polling
    function startGPSPolling() {
        // First, ensure GPS tracking is started on the server
        fetch('/api/gps/start', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                console.log('GPS tracking started:', data);
                // Start polling for position updates
                gpsPollingInterval = setInterval(loadGPSPosition, GPS_POLL_INTERVAL);
            })
            .catch(err => console.error('Failed to start GPS tracking:', err));
    }

    // Fetch and update GPS position
    async function loadGPSPosition() {
        try {
            const response = await fetch('/api/gps/position');
            const gps = await response.json();

            if (gps) {
                lastGpsPosition = gps;

                // Update coordinates
                document.getElementById('nav-lat').textContent = gps.latitude.toFixed(6) + '°';
                document.getElementById('nav-lon').textContent = gps.longitude.toFixed(6) + '°';
                document.getElementById('nav-alt').textContent = gps.altitude + ' m';

                // Update accuracy display
                document.getElementById('nav-accuracy').textContent = '±' + gps.accuracy.toFixed(1) + ' m';

                // Update accuracy indicator
                const accuracyIndicator = document.getElementById('nav-accuracy-indicator');
                accuracyIndicator.textContent = '(' + gps.accuracy_indicator + ')';
                accuracyIndicator.className = 'accuracy-indicator ' + gps.accuracy_indicator;

                // Update accuracy badge
                const accuracyBadge = document.getElementById('gps-accuracy-badge');
                accuracyBadge.className = 'accuracy-badge accuracy-' + gps.accuracy_indicator;

                // Update heading from GPS
                if (gps.heading !== undefined) {
                    document.getElementById('compass-needle').style.transform = `rotate(${gps.heading}deg)`;
                    document.getElementById('heading-value').textContent = Math.round(gps.heading);
                }

                console.log('GPS position updated:', gps.coordinates_formatted, 'Accuracy:', gps.accuracy_indicator);
            }
        } catch (error) {
            console.error('Failed to fetch GPS position:', error);
        }
    }

    // Legacy function for compatibility
    async function loadNavigationData() {
        await loadGPSPosition();
    }

    // ==============================================================================
    // Waypoint Management
    // ==============================================================================

    // Load waypoints on page load
    loadWaypoints();

    // Open waypoint dialog
    document.getElementById('mark-waypoint').addEventListener('click', function() {
        if (lastGpsPosition) {
            // Update dialog with current position
            document.getElementById('dialog-position').textContent =
                `${lastGpsPosition.latitude.toFixed(6)}°, ${lastGpsPosition.longitude.toFixed(6)}°`;
            // Show dialog
            document.getElementById('waypoint-dialog').classList.remove('hidden');
            // Focus on name input
            document.getElementById('waypoint-name').focus();
        } else {
            alert('Waiting for GPS fix...');
        }
    });

    // Cancel waypoint dialog
    document.getElementById('cancel-waypoint').addEventListener('click', function() {
        document.getElementById('waypoint-dialog').classList.add('hidden');
        document.getElementById('waypoint-form').reset();
    });

    // Close dialog when clicking overlay
    document.getElementById('waypoint-dialog').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
            document.getElementById('waypoint-form').reset();
        }
    });

    // Submit waypoint form
    document.getElementById('waypoint-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const name = document.getElementById('waypoint-name').value.trim();
        const category = document.getElementById('waypoint-category').value;
        const notes = document.getElementById('waypoint-notes').value.trim();

        if (!name) {
            alert('Please enter a waypoint name');
            return;
        }

        try {
            const response = await fetch('/api/waypoints/mark', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, category, notes })
            });

            const result = await response.json();

            if (result.success) {
                // Close dialog
                document.getElementById('waypoint-dialog').classList.add('hidden');
                document.getElementById('waypoint-form').reset();

                // Reload waypoints list
                loadWaypoints();

                // Show confirmation
                console.log('Waypoint saved:', result.waypoint);
            } else {
                alert('Failed to save waypoint: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error saving waypoint:', error);
            alert('Failed to save waypoint');
        }
    });

    // Load waypoints from API
    async function loadWaypoints() {
        try {
            const response = await fetch('/api/waypoints');
            const result = await response.json();

            if (result.success) {
                renderWaypoints(result.waypoints);
                document.getElementById('waypoint-count').textContent = `(${result.count})`;
            }
        } catch (error) {
            console.error('Failed to load waypoints:', error);
        }
    }

    // Render waypoints list
    function renderWaypoints(waypointsList) {
        const container = document.getElementById('waypoints-list');

        if (waypointsList.length === 0) {
            container.innerHTML = '<p class="no-waypoints">No waypoints saved yet</p>';
            return;
        }

        container.innerHTML = waypointsList.map(wp => `
            <div class="waypoint-item" data-id="${wp.id}">
                <div class="waypoint-info">
                    <span class="waypoint-name">${escapeHtml(wp.name)}</span>
                    <span class="waypoint-category">${wp.category}</span>
                    <div class="waypoint-coords">${wp.latitude.toFixed(6)}°, ${wp.longitude.toFixed(6)}°</div>
                </div>
                <div class="waypoint-actions">
                    <button class="waypoint-navigate" onclick="startNavigation(${wp.id})" title="Navigate to waypoint">
                        Go
                    </button>
                    <button class="waypoint-delete" onclick="deleteWaypoint(${wp.id})" title="Delete waypoint">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Delete waypoint
    async function deleteWaypoint(id) {
        if (!confirm('Delete this waypoint?')) return;

        try {
            const response = await fetch(`/api/waypoints/${id}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                loadWaypoints();
                console.log('Waypoint deleted:', result.deleted);
            } else {
                alert('Failed to delete waypoint');
            }
        } catch (error) {
            console.error('Error deleting waypoint:', error);
        }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==============================================================================
    // Navigation to Waypoint
    // ==============================================================================

    let navigationPollingInterval = null;

    // Start navigation to a waypoint
    async function startNavigation(waypointId) {
        try {
            const response = await fetch(`/api/navigate/to/${waypointId}`, {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                // Show navigation panel
                document.getElementById('navigation-panel').classList.remove('hidden');
                document.getElementById('nav-target-name').textContent = result.target.name;

                // Update initial values
                updateNavigationDisplay(result.navigation);

                // Start polling for navigation updates
                startNavigationPolling();

                console.log('Navigation started to:', result.target.name);
            } else {
                alert('Failed to start navigation: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error starting navigation:', error);
            alert('Failed to start navigation');
        }
    }

    // Start polling for navigation updates
    function startNavigationPolling() {
        if (navigationPollingInterval) {
            clearInterval(navigationPollingInterval);
        }

        navigationPollingInterval = setInterval(updateNavigationStatus, 1000);
    }

    // Fetch and update navigation status
    async function updateNavigationStatus() {
        try {
            const response = await fetch('/api/navigate/status');
            const result = await response.json();

            if (result.active) {
                updateNavigationDisplay(result.navigation);
            } else {
                // Navigation stopped
                stopNavigationPolling();
                document.getElementById('navigation-panel').classList.add('hidden');
            }
        } catch (error) {
            console.error('Error fetching navigation status:', error);
        }
    }

    // Update the navigation display
    function updateNavigationDisplay(navData) {
        document.getElementById('nav-distance').textContent = navData.distance.display;
        document.getElementById('nav-bearing').textContent = navData.bearing + '°';
        document.getElementById('nav-direction').textContent = navData.bearing_direction;

        // Update arrow rotation to point toward waypoint
        // The arrow should point in the direction we need to turn
        const arrowRotation = navData.relative_bearing || navData.bearing;
        document.getElementById('nav-arrow').style.transform = `rotate(${arrowRotation}deg)`;

        // Check if arrived
        if (navData.arrived) {
            alert('You have arrived at your destination!');
            stopNavigation();
        }
    }

    // Stop navigation
    async function stopNavigation() {
        try {
            await fetch('/api/navigate/stop', { method: 'POST' });
        } catch (error) {
            console.error('Error stopping navigation:', error);
        }

        stopNavigationPolling();
        document.getElementById('navigation-panel').classList.add('hidden');
    }

    // Stop polling for navigation updates
    function stopNavigationPolling() {
        if (navigationPollingInterval) {
            clearInterval(navigationPollingInterval);
            navigationPollingInterval = null;
        }
    }

    // Stop navigation button handler
    document.getElementById('stop-navigation').addEventListener('click', stopNavigation);

    // Check for active navigation on page load
    async function checkActiveNavigation() {
        try {
            const response = await fetch('/api/navigate/status');
            const result = await response.json();

            if (result.active) {
                document.getElementById('navigation-panel').classList.remove('hidden');
                document.getElementById('nav-target-name').textContent = result.target.name;
                updateNavigationDisplay(result.navigation);
                startNavigationPolling();
            }
        } catch (error) {
            console.error('Error checking navigation status:', error);
        }
    }

    // Check for active navigation on page load
    checkActiveNavigation();

    document.getElementById('start-breadcrumbs').addEventListener('click', function() {
        this.textContent = 'Recording...';
        this.style.background = 'var(--accent-primary)';
    });

    // ==============================================================================
    // I'm Lost Emergency Mode
    // ==============================================================================

    let lostModePollingInterval = null;

    document.getElementById('im-lost').addEventListener('click', function() {
        activateLostMode();
    });

    // Activate I'm Lost mode
    async function activateLostMode() {
        try {
            const response = await fetch('/api/lost-mode/activate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();

            if (result.success) {
                // Show the lost mode panel
                document.getElementById('lost-mode-panel').classList.remove('hidden');

                // Update the UI with the response data
                updateLostModeUI(result.data);

                // Update button state
                const imLostBtn = document.getElementById('im-lost');
                imLostBtn.textContent = 'Mode Active';
                imLostBtn.style.background = 'var(--accent-danger)';
                imLostBtn.style.color = 'white';
                imLostBtn.disabled = true;

                // Start polling for updates
                startLostModePolling();

                console.log('I\'m Lost mode activated:', result.message);
            } else {
                alert('Failed to activate I\'m Lost mode: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error activating I\'m Lost mode:', error);
            alert('Failed to activate I\'m Lost mode');
        }
    }

    // Update the Lost Mode UI with data from API
    function updateLostModeUI(data) {
        // Update acknowledgment message
        document.getElementById('lost-ack-message').textContent =
            'Acknowledged. Stay calm. The system is here to help you find your way back.';

        // Update guidance steps
        if (data.guidance && data.guidance.steps) {
            const stepsContainer = document.getElementById('lost-guidance-steps');
            stepsContainer.innerHTML = data.guidance.steps.map((step, index) => `
                <div class="guidance-step">
                    <div class="guidance-step-number">${index + 1}</div>
                    <div class="guidance-step-content">
                        <div class="guidance-step-action">${escapeHtml(step.action)}</div>
                        <div class="guidance-step-detail">${escapeHtml(step.detail)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Update nearby waypoints
        if (data.nearby_waypoints && data.nearby_waypoints.length > 0) {
            const waypointsContainer = document.getElementById('lost-waypoints-list');
            waypointsContainer.innerHTML = data.nearby_waypoints.map(wp => `
                <div class="lost-waypoint-item" onclick="startNavigation(${wp.id})">
                    <div class="lost-waypoint-name">${escapeHtml(wp.name)}</div>
                    <div class="lost-waypoint-distance">${wp.distance.display}</div>
                    <div class="lost-waypoint-direction">${wp.bearing}° ${wp.bearing_direction}</div>
                </div>
            `).join('');
        } else {
            document.getElementById('lost-waypoints-list').innerHTML =
                '<p class="no-waypoints">No waypoints saved. Consider marking your current position.</p>';
        }

        // Update backtrack info
        const backtrackInfo = document.getElementById('lost-backtrack-info');
        const backtrackBtn = document.getElementById('start-backtrack');

        if (data.backtrack_route && data.backtrack_route.available) {
            backtrackInfo.className = 'backtrack-info backtrack-available';
            backtrackInfo.innerHTML = `
                <p><strong>Trail Available:</strong> <span class="backtrack-trail-name">${escapeHtml(data.backtrack_route.trail_name)}</span></p>
                <div class="backtrack-stats">
                    <span>${data.backtrack_route.points_count} points</span>
                    <span>${data.backtrack_route.total_distance.display}</span>
                </div>
            `;
            backtrackBtn.classList.remove('hidden');
            backtrackBtn.onclick = () => showBacktrackRoute(data.backtrack_route.trail_id);
        } else {
            backtrackInfo.className = 'backtrack-info backtrack-unavailable';
            backtrackInfo.innerHTML = `
                <p>No breadcrumb trail available. If you recorded a trail while hiking, it would appear here.</p>
            `;
            backtrackBtn.classList.add('hidden');
        }

        // Update tips
        if (data.guidance && data.guidance.tips) {
            const tipsList = document.getElementById('lost-tips-list');
            tipsList.innerHTML = data.guidance.tips.map(tip => `
                <li>${escapeHtml(tip)}</li>
            `).join('');
        }
    }

    // Poll for lost mode status updates
    function startLostModePolling() {
        if (lostModePollingInterval) {
            clearInterval(lostModePollingInterval);
        }

        lostModePollingInterval = setInterval(async () => {
            try {
                const response = await fetch('/api/lost-mode/status');
                const status = await response.json();

                if (status.active) {
                    // Update waypoint distances (they change as GPS position changes)
                    if (status.nearby_waypoints && status.nearby_waypoints.length > 0) {
                        const waypointsContainer = document.getElementById('lost-waypoints-list');
                        waypointsContainer.innerHTML = status.nearby_waypoints.map(wp => `
                            <div class="lost-waypoint-item" onclick="startNavigation(${wp.id})">
                                <div class="lost-waypoint-name">${escapeHtml(wp.name)}</div>
                                <div class="lost-waypoint-distance">${wp.distance.display}</div>
                                <div class="lost-waypoint-direction">${wp.bearing}° ${wp.bearing_direction}</div>
                            </div>
                        `).join('');
                    }
                } else {
                    // Mode was deactivated externally
                    stopLostModePolling();
                    hideLostModePanel();
                }
            } catch (error) {
                console.error('Error polling lost mode status:', error);
            }
        }, 2000); // Update every 2 seconds
    }

    // Stop polling
    function stopLostModePolling() {
        if (lostModePollingInterval) {
            clearInterval(lostModePollingInterval);
            lostModePollingInterval = null;
        }
    }

    // Hide lost mode panel and reset button
    function hideLostModePanel() {
        document.getElementById('lost-mode-panel').classList.add('hidden');

        // Reset button state
        const imLostBtn = document.getElementById('im-lost');
        imLostBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
            I'm Lost
        `;
        imLostBtn.style.background = '';
        imLostBtn.style.color = '';
        imLostBtn.disabled = false;
    }

    // Exit lost mode handler
    document.getElementById('exit-lost-mode').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/lost-mode/deactivate', {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                stopLostModePolling();
                hideLostModePanel();
                console.log('I\'m Lost mode deactivated');
            }
        } catch (error) {
            console.error('Error deactivating lost mode:', error);
        }
    });

    // SOS button handler
    document.getElementById('activate-sos').addEventListener('click', function() {
        if (confirm('Activate SOS Emergency Beacon? This will emit an audio and visual distress signal.')) {
            // Navigate to emergency page
            window.location.href = '/emergency';
        }
    });

    // Show backtrack route details
    async function showBacktrackRoute(trailId) {
        try {
            const response = await fetch('/api/lost-mode/backtrack');
            const result = await response.json();

            if (result.success) {
                // For now, show an alert with backtrack info
                // In a full implementation, this would show a map or step-by-step directions
                const hint = result.navigation_hint;
                const nearestPoint = result.points.find(p => p.is_nearest);

                let message = `Backtrack Route: ${result.trail_name}\n\n`;
                message += `Total Distance: ${result.total_distance.display}\n`;
                message += `Total Points: ${result.total_points}\n\n`;
                message += `${hint}\n`;

                if (nearestPoint) {
                    message += `\nNearest trail point is ${nearestPoint.distance_from_current.display} to the ${nearestPoint.direction_from_current}`;
                }

                alert(message);
            } else {
                alert('Could not load backtrack route: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error loading backtrack route:', error);
            alert('Failed to load backtrack route');
        }
    }

    // Check for active lost mode on page load
    async function checkActiveLostMode() {
        try {
            const response = await fetch('/api/lost-mode/status');
            const status = await response.json();

            if (status.active) {
                // Restore the lost mode UI
                document.getElementById('lost-mode-panel').classList.remove('hidden');
                updateLostModeUI({
                    guidance: status.guidance,
                    nearby_waypoints: status.nearby_waypoints,
                    backtrack_route: status.backtrack_route
                });

                // Update button state
                const imLostBtn = document.getElementById('im-lost');
                imLostBtn.textContent = 'Mode Active';
                imLostBtn.style.background = 'var(--accent-danger)';
                imLostBtn.style.color = 'white';
                imLostBtn.disabled = true;

                // Start polling
                startLostModePolling();
            }
        } catch (error) {
            console.error('Error checking lost mode status:', error);
        }
    }

    // Check for active lost mode on page load
    checkActiveLostMode();

    // Cleanup when leaving the page
    window.addEventListener('beforeunload', function() {
        if (gpsPollingInterval) {
            clearInterval(gpsPollingInterval);
        }
    });
</script>
{% endblock %}
