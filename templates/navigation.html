{% extends "base.html" %}

{% block title %}Survival Companion - Navigation{% endblock %}

{% block content %}
<div class="navigation-container">
    <div class="map-placeholder">
        <div class="map-content">
            <svg viewBox="0 0 24 24" fill="currentColor" class="map-icon">
                <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>
            </svg>
            <p>Offline Map View</p>
            <span class="map-note">Maps require MBTiles download</span>
        </div>
    </div>

    <div class="nav-info-panel">
        <div class="position-card">
            <h3>Current Position <span id="gps-accuracy-badge" class="accuracy-badge accuracy-high">●</span></h3>
            <div class="coords-display">
                <div class="coord">
                    <span class="coord-label">LAT</span>
                    <span class="coord-value" id="nav-lat">-33.8688°</span>
                </div>
                <div class="coord">
                    <span class="coord-label">LON</span>
                    <span class="coord-value" id="nav-lon">151.2093°</span>
                </div>
                <div class="coord">
                    <span class="coord-label">ALT</span>
                    <span class="coord-value" id="nav-alt">58 m</span>
                </div>
            </div>
            <div class="accuracy-display">
                <span class="accuracy-label">Accuracy:</span>
                <span class="accuracy-value" id="nav-accuracy">±3.5 m</span>
                <span class="accuracy-indicator" id="nav-accuracy-indicator">(high)</span>
            </div>
        </div>

        <div class="nav-actions">
            <button class="nav-btn" id="mark-waypoint">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
                Mark Waypoint
            </button>
            <button class="nav-btn" id="start-breadcrumbs">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
                Start Trail
            </button>
            <button class="nav-btn emergency" id="im-lost">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                I'm Lost
            </button>
        </div>

        <div class="compass-widget">
            <div class="compass-ring">
                <div class="compass-needle" id="compass-needle">
                    <div class="needle-n">N</div>
                </div>
            </div>
            <div class="compass-heading">
                <span id="heading-value">0</span>°
            </div>
        </div>

        <!-- Navigation Target Panel (hidden by default) -->
        <div id="navigation-panel" class="navigation-panel hidden">
            <h3>Navigating to: <span id="nav-target-name">--</span></h3>
            <div class="navigation-info">
                <div class="nav-stat">
                    <span class="nav-stat-label">Distance</span>
                    <span class="nav-stat-value" id="nav-distance">-- m</span>
                </div>
                <div class="nav-stat">
                    <span class="nav-stat-label">Bearing</span>
                    <span class="nav-stat-value" id="nav-bearing">--°</span>
                </div>
                <div class="nav-stat">
                    <span class="nav-stat-label">Direction</span>
                    <span class="nav-stat-value" id="nav-direction">--</span>
                </div>
            </div>
            <div class="nav-compass-arrow">
                <div id="nav-arrow" class="arrow">↑</div>
                <span class="arrow-hint">Point this direction</span>
            </div>
            <button id="stop-navigation" class="btn btn-danger">Stop Navigation</button>
        </div>

        <!-- Waypoints List -->
        <div class="waypoints-card">
            <h3>Saved Waypoints <span id="waypoint-count" class="waypoint-count">(0)</span></h3>
            <div id="waypoints-list" class="waypoints-list">
                <p class="no-waypoints">No waypoints saved yet</p>
            </div>
        </div>
    </div>
</div>

<!-- Waypoint Dialog -->
<div id="waypoint-dialog" class="dialog-overlay hidden">
    <div class="dialog-content">
        <h3>Mark Waypoint</h3>
        <form id="waypoint-form">
            <div class="form-group">
                <label for="waypoint-name">Name *</label>
                <input type="text" id="waypoint-name" placeholder="Enter waypoint name" required>
            </div>
            <div class="form-group">
                <label for="waypoint-category">Category</label>
                <select id="waypoint-category">
                    <option value="camp">Camp</option>
                    <option value="water">Water Source</option>
                    <option value="danger">Danger</option>
                    <option value="landmark">Landmark</option>
                    <option value="general" selected>General</option>
                </select>
            </div>
            <div class="form-group">
                <label for="waypoint-notes">Notes</label>
                <textarea id="waypoint-notes" placeholder="Optional notes"></textarea>
            </div>
            <div class="form-group position-preview">
                <span class="position-label">Position:</span>
                <span id="dialog-position" class="position-value">--.-----°, --.-----°</span>
            </div>
            <div class="dialog-actions">
                <button type="button" class="btn btn-secondary" id="cancel-waypoint">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Waypoint</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .navigation-container {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        height: calc(100vh - var(--status-bar-height) - var(--nav-bar-height) - 40px);
    }

    .map-placeholder {
        flex: 1;
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 200px;
    }

    .map-content {
        text-align: center;
        color: var(--text-secondary);
    }

    .map-icon {
        width: 64px;
        height: 64px;
        opacity: 0.5;
        margin-bottom: var(--spacing-sm);
    }

    .map-note {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        display: block;
        margin-top: var(--spacing-xs);
    }

    .nav-info-panel {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .position-card {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
    }

    .position-card h3 {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        margin-bottom: var(--spacing-sm);
    }

    .coords-display {
        display: flex;
        justify-content: space-between;
    }

    .coord {
        text-align: center;
    }

    .coord-label {
        display: block;
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-bottom: var(--spacing-xs);
    }

    .coord-value {
        font-family: monospace;
        font-size: var(--font-size-base);
        font-weight: 600;
        color: var(--accent-secondary);
    }

    .nav-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    .nav-btn {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-sm);
        background: var(--bg-card);
        border: none;
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: var(--font-size-xs);
        cursor: pointer;
        min-height: var(--touch-preferred);
        transition: background 0.2s;
    }

    .nav-btn:active {
        background: var(--bg-hover);
    }

    .nav-btn svg {
        width: 24px;
        height: 24px;
        margin-bottom: var(--spacing-xs);
        color: var(--accent-secondary);
    }

    .nav-btn.emergency svg {
        color: var(--accent-danger);
    }

    .compass-widget {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
    }

    .compass-ring {
        width: 80px;
        height: 80px;
        border: 2px solid var(--text-muted);
        border-radius: 50%;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .compass-needle {
        width: 60px;
        height: 60px;
        position: relative;
        transition: transform 0.3s ease;
    }

    .needle-n {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        font-weight: 700;
        color: var(--accent-danger);
        font-size: var(--font-size-sm);
    }

    .compass-heading {
        font-size: var(--font-size-2xl);
        font-weight: 700;
        font-family: monospace;
    }

    .accuracy-display {
        margin-top: var(--spacing-sm);
        padding-top: var(--spacing-sm);
        border-top: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--font-size-sm);
    }

    .accuracy-label {
        color: var(--text-muted);
    }

    .accuracy-value {
        font-family: monospace;
        font-weight: 600;
        color: var(--text-primary);
    }

    .accuracy-indicator {
        font-size: var(--font-size-xs);
    }

    .accuracy-indicator.high {
        color: var(--success, #00ff00);
    }

    .accuracy-indicator.medium {
        color: var(--warning, #ffa500);
    }

    .accuracy-indicator.low {
        color: var(--accent-danger, #ff0000);
    }

    .accuracy-badge {
        font-size: var(--font-size-xs);
        margin-left: var(--spacing-xs);
    }

    .accuracy-badge.accuracy-high {
        color: var(--success, #00ff00);
    }

    .accuracy-badge.accuracy-medium {
        color: var(--warning, #ffa500);
    }

    .accuracy-badge.accuracy-low {
        color: var(--accent-danger, #ff0000);
    }

    .gps-update-indicator {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-left: auto;
    }

    .gps-update-indicator.updating {
        color: var(--accent-primary);
    }

    /* Waypoints Card */
    .waypoints-card {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
    }

    .waypoints-card h3 {
        font-size: var(--font-size-sm);
        color: var(--text-secondary);
        margin-bottom: var(--spacing-sm);
    }

    .waypoint-count {
        color: var(--text-muted);
        font-weight: normal;
    }

    .waypoints-list {
        max-height: 150px;
        overflow-y: auto;
    }

    .no-waypoints {
        color: var(--text-muted);
        font-size: var(--font-size-sm);
        text-align: center;
        padding: var(--spacing-md);
    }

    .waypoint-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-sm);
        border-bottom: 1px solid var(--border-color);
    }

    .waypoint-item:last-child {
        border-bottom: none;
    }

    .waypoint-info {
        flex: 1;
    }

    .waypoint-name {
        font-weight: 600;
        font-size: var(--font-size-sm);
    }

    .waypoint-coords {
        font-family: monospace;
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }

    .waypoint-category {
        font-size: var(--font-size-xs);
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        background: var(--bg-hover);
        color: var(--text-secondary);
        margin-left: var(--spacing-xs);
    }

    .waypoint-delete {
        background: transparent;
        border: none;
        color: var(--accent-danger);
        cursor: pointer;
        padding: var(--spacing-xs);
    }

    /* Dialog */
    .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .dialog-overlay.hidden {
        display: none;
    }

    .dialog-content {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        width: 90%;
        max-width: 400px;
    }

    .dialog-content h3 {
        margin-bottom: var(--spacing-md);
        color: var(--text-primary);
    }

    .form-group {
        margin-bottom: var(--spacing-md);
    }

    .form-group label {
        display: block;
        margin-bottom: var(--spacing-xs);
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: var(--spacing-sm);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background: var(--bg-main);
        color: var(--text-primary);
        font-size: var(--font-size-base);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 60px;
    }

    .position-preview {
        background: var(--bg-hover);
        padding: var(--spacing-sm);
        border-radius: var(--radius-md);
    }

    .position-label {
        color: var(--text-muted);
        font-size: var(--font-size-sm);
    }

    .position-value {
        font-family: monospace;
        color: var(--accent-secondary);
        font-weight: 600;
    }

    .dialog-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
    }

    .dialog-actions .btn {
        flex: 1;
        padding: var(--spacing-sm) var(--spacing-md);
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: var(--font-size-base);
    }

    .btn-primary {
        background: var(--accent-primary);
        color: white;
    }

    .btn-secondary {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .btn-danger {
        background: var(--accent-danger, #ff0000);
        color: white;
    }

    /* Navigation Panel */
    .navigation-panel {
        background: linear-gradient(135deg, var(--bg-card), var(--accent-primary-transparent, rgba(0, 100, 200, 0.2)));
        border: 2px solid var(--accent-primary, #0066cc);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
    }

    .navigation-panel.hidden {
        display: none;
    }

    .navigation-panel h3 {
        color: var(--accent-primary, #0066cc);
        margin-bottom: var(--spacing-md);
        font-size: var(--font-size-base);
    }

    #nav-target-name {
        color: var(--text-primary);
        font-weight: 700;
    }

    .navigation-info {
        display: flex;
        justify-content: space-around;
        margin-bottom: var(--spacing-md);
    }

    .nav-stat {
        text-align: center;
    }

    .nav-stat-label {
        display: block;
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-bottom: var(--spacing-xs);
    }

    .nav-stat-value {
        font-family: monospace;
        font-size: var(--font-size-lg);
        font-weight: 700;
        color: var(--accent-secondary);
    }

    .nav-compass-arrow {
        text-align: center;
        margin-bottom: var(--spacing-md);
    }

    .arrow {
        font-size: 48px;
        color: var(--accent-primary);
        transition: transform 0.3s ease;
        line-height: 1;
    }

    .arrow-hint {
        display: block;
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-top: var(--spacing-xs);
    }

    /* Waypoint item with navigate button */
    .waypoint-actions {
        display: flex;
        gap: var(--spacing-xs);
    }

    .waypoint-navigate {
        background: var(--accent-primary);
        border: none;
        color: white;
        cursor: pointer;
        padding: var(--spacing-xs);
        border-radius: var(--radius-sm);
        font-size: var(--font-size-xs);
    }

    .waypoint-navigate:hover {
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // GPS polling interval handle
    let gpsPollingInterval = null;
    let lastGpsPosition = null;
    const GPS_POLL_INTERVAL = 1000; // Poll every 1 second for real-time updates

    document.addEventListener('DOMContentLoaded', function() {
        // Load initial GPS data
        loadGPSPosition();

        // Start real-time GPS polling
        startGPSPolling();

        // Update compass from GPS heading
        setInterval(() => {
            if (lastGpsPosition && lastGpsPosition.heading !== undefined) {
                document.getElementById('compass-needle').style.transform = `rotate(${lastGpsPosition.heading}deg)`;
                document.getElementById('heading-value').textContent = Math.round(lastGpsPosition.heading);
            }
        }, 500);
    });

    // Start GPS tracking and polling
    function startGPSPolling() {
        // First, ensure GPS tracking is started on the server
        fetch('/api/gps/start', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                console.log('GPS tracking started:', data);
                // Start polling for position updates
                gpsPollingInterval = setInterval(loadGPSPosition, GPS_POLL_INTERVAL);
            })
            .catch(err => console.error('Failed to start GPS tracking:', err));
    }

    // Fetch and update GPS position
    async function loadGPSPosition() {
        try {
            const response = await fetch('/api/gps/position');
            const gps = await response.json();

            if (gps) {
                lastGpsPosition = gps;

                // Update coordinates
                document.getElementById('nav-lat').textContent = gps.latitude.toFixed(6) + '°';
                document.getElementById('nav-lon').textContent = gps.longitude.toFixed(6) + '°';
                document.getElementById('nav-alt').textContent = gps.altitude + ' m';

                // Update accuracy display
                document.getElementById('nav-accuracy').textContent = '±' + gps.accuracy.toFixed(1) + ' m';

                // Update accuracy indicator
                const accuracyIndicator = document.getElementById('nav-accuracy-indicator');
                accuracyIndicator.textContent = '(' + gps.accuracy_indicator + ')';
                accuracyIndicator.className = 'accuracy-indicator ' + gps.accuracy_indicator;

                // Update accuracy badge
                const accuracyBadge = document.getElementById('gps-accuracy-badge');
                accuracyBadge.className = 'accuracy-badge accuracy-' + gps.accuracy_indicator;

                // Update heading from GPS
                if (gps.heading !== undefined) {
                    document.getElementById('compass-needle').style.transform = `rotate(${gps.heading}deg)`;
                    document.getElementById('heading-value').textContent = Math.round(gps.heading);
                }

                console.log('GPS position updated:', gps.coordinates_formatted, 'Accuracy:', gps.accuracy_indicator);
            }
        } catch (error) {
            console.error('Failed to fetch GPS position:', error);
        }
    }

    // Legacy function for compatibility
    async function loadNavigationData() {
        await loadGPSPosition();
    }

    // ==============================================================================
    // Waypoint Management
    // ==============================================================================

    // Load waypoints on page load
    loadWaypoints();

    // Open waypoint dialog
    document.getElementById('mark-waypoint').addEventListener('click', function() {
        if (lastGpsPosition) {
            // Update dialog with current position
            document.getElementById('dialog-position').textContent =
                `${lastGpsPosition.latitude.toFixed(6)}°, ${lastGpsPosition.longitude.toFixed(6)}°`;
            // Show dialog
            document.getElementById('waypoint-dialog').classList.remove('hidden');
            // Focus on name input
            document.getElementById('waypoint-name').focus();
        } else {
            alert('Waiting for GPS fix...');
        }
    });

    // Cancel waypoint dialog
    document.getElementById('cancel-waypoint').addEventListener('click', function() {
        document.getElementById('waypoint-dialog').classList.add('hidden');
        document.getElementById('waypoint-form').reset();
    });

    // Close dialog when clicking overlay
    document.getElementById('waypoint-dialog').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
            document.getElementById('waypoint-form').reset();
        }
    });

    // Submit waypoint form
    document.getElementById('waypoint-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const name = document.getElementById('waypoint-name').value.trim();
        const category = document.getElementById('waypoint-category').value;
        const notes = document.getElementById('waypoint-notes').value.trim();

        if (!name) {
            alert('Please enter a waypoint name');
            return;
        }

        try {
            const response = await fetch('/api/waypoints/mark', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, category, notes })
            });

            const result = await response.json();

            if (result.success) {
                // Close dialog
                document.getElementById('waypoint-dialog').classList.add('hidden');
                document.getElementById('waypoint-form').reset();

                // Reload waypoints list
                loadWaypoints();

                // Show confirmation
                console.log('Waypoint saved:', result.waypoint);
            } else {
                alert('Failed to save waypoint: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error saving waypoint:', error);
            alert('Failed to save waypoint');
        }
    });

    // Load waypoints from API
    async function loadWaypoints() {
        try {
            const response = await fetch('/api/waypoints');
            const result = await response.json();

            if (result.success) {
                renderWaypoints(result.waypoints);
                document.getElementById('waypoint-count').textContent = `(${result.count})`;
            }
        } catch (error) {
            console.error('Failed to load waypoints:', error);
        }
    }

    // Render waypoints list
    function renderWaypoints(waypointsList) {
        const container = document.getElementById('waypoints-list');

        if (waypointsList.length === 0) {
            container.innerHTML = '<p class="no-waypoints">No waypoints saved yet</p>';
            return;
        }

        container.innerHTML = waypointsList.map(wp => `
            <div class="waypoint-item" data-id="${wp.id}">
                <div class="waypoint-info">
                    <span class="waypoint-name">${escapeHtml(wp.name)}</span>
                    <span class="waypoint-category">${wp.category}</span>
                    <div class="waypoint-coords">${wp.latitude.toFixed(6)}°, ${wp.longitude.toFixed(6)}°</div>
                </div>
                <div class="waypoint-actions">
                    <button class="waypoint-navigate" onclick="startNavigation(${wp.id})" title="Navigate to waypoint">
                        Go
                    </button>
                    <button class="waypoint-delete" onclick="deleteWaypoint(${wp.id})" title="Delete waypoint">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Delete waypoint
    async function deleteWaypoint(id) {
        if (!confirm('Delete this waypoint?')) return;

        try {
            const response = await fetch(`/api/waypoints/${id}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                loadWaypoints();
                console.log('Waypoint deleted:', result.deleted);
            } else {
                alert('Failed to delete waypoint');
            }
        } catch (error) {
            console.error('Error deleting waypoint:', error);
        }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==============================================================================
    // Navigation to Waypoint
    // ==============================================================================

    let navigationPollingInterval = null;

    // Start navigation to a waypoint
    async function startNavigation(waypointId) {
        try {
            const response = await fetch(`/api/navigate/to/${waypointId}`, {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                // Show navigation panel
                document.getElementById('navigation-panel').classList.remove('hidden');
                document.getElementById('nav-target-name').textContent = result.target.name;

                // Update initial values
                updateNavigationDisplay(result.navigation);

                // Start polling for navigation updates
                startNavigationPolling();

                console.log('Navigation started to:', result.target.name);
            } else {
                alert('Failed to start navigation: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error starting navigation:', error);
            alert('Failed to start navigation');
        }
    }

    // Start polling for navigation updates
    function startNavigationPolling() {
        if (navigationPollingInterval) {
            clearInterval(navigationPollingInterval);
        }

        navigationPollingInterval = setInterval(updateNavigationStatus, 1000);
    }

    // Fetch and update navigation status
    async function updateNavigationStatus() {
        try {
            const response = await fetch('/api/navigate/status');
            const result = await response.json();

            if (result.active) {
                updateNavigationDisplay(result.navigation);
            } else {
                // Navigation stopped
                stopNavigationPolling();
                document.getElementById('navigation-panel').classList.add('hidden');
            }
        } catch (error) {
            console.error('Error fetching navigation status:', error);
        }
    }

    // Update the navigation display
    function updateNavigationDisplay(navData) {
        document.getElementById('nav-distance').textContent = navData.distance.display;
        document.getElementById('nav-bearing').textContent = navData.bearing + '°';
        document.getElementById('nav-direction').textContent = navData.bearing_direction;

        // Update arrow rotation to point toward waypoint
        // The arrow should point in the direction we need to turn
        const arrowRotation = navData.relative_bearing || navData.bearing;
        document.getElementById('nav-arrow').style.transform = `rotate(${arrowRotation}deg)`;

        // Check if arrived
        if (navData.arrived) {
            alert('You have arrived at your destination!');
            stopNavigation();
        }
    }

    // Stop navigation
    async function stopNavigation() {
        try {
            await fetch('/api/navigate/stop', { method: 'POST' });
        } catch (error) {
            console.error('Error stopping navigation:', error);
        }

        stopNavigationPolling();
        document.getElementById('navigation-panel').classList.add('hidden');
    }

    // Stop polling for navigation updates
    function stopNavigationPolling() {
        if (navigationPollingInterval) {
            clearInterval(navigationPollingInterval);
            navigationPollingInterval = null;
        }
    }

    // Stop navigation button handler
    document.getElementById('stop-navigation').addEventListener('click', stopNavigation);

    // Check for active navigation on page load
    async function checkActiveNavigation() {
        try {
            const response = await fetch('/api/navigate/status');
            const result = await response.json();

            if (result.active) {
                document.getElementById('navigation-panel').classList.remove('hidden');
                document.getElementById('nav-target-name').textContent = result.target.name;
                updateNavigationDisplay(result.navigation);
                startNavigationPolling();
            }
        } catch (error) {
            console.error('Error checking navigation status:', error);
        }
    }

    // Check for active navigation on page load
    checkActiveNavigation();

    document.getElementById('start-breadcrumbs').addEventListener('click', function() {
        this.textContent = 'Recording...';
        this.style.background = 'var(--accent-primary)';
    });

    document.getElementById('im-lost').addEventListener('click', function() {
        if (confirm('Activate "I\'m Lost" mode? This will display your last known position and provide guidance.')) {
            alert('I\'m Lost mode activated. Follow breadcrumbs to return to your last waypoint.');
        }
    });

    // Cleanup when leaving the page
    window.addEventListener('beforeunload', function() {
        if (gpsPollingInterval) {
            clearInterval(gpsPollingInterval);
        }
    });
</script>
{% endblock %}
